é¡¹ç›®è·¨åº¦ä¸º **2025å¹´11æœˆ14æ—¥ è‡³ 2025å¹´12æœˆ18æ—¥**ï¼Œä¸»è¦é›†ä¸­åœ¨ **Web/å®¢æˆ·ç«¯** ä¸ **Server/æœåŠ¡ç«¯** çš„å³æ—¶é€šè®¯åŠŸèƒ½å¼€å‘ã€‚

---

# 1. é¡¹ç›®è¿›åº¦è¡¨

| é˜¶æ®µ | æ—¶é—´å‘¨æœŸ | ä»»åŠ¡æ¨¡å— | è¯¦ç»†å†…å®¹ä¸é‡Œç¨‹ç¢‘ | ä¸»è¦è´Ÿè´£äºº | çŠ¶æ€ |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **P1** | 11.14 - 11.15 | **é¡¹ç›®åˆå§‹åŒ–** | â€¢ åˆå§‹åŒ– Web ç«¯æ¶æ„<br>â€¢ æ¸…ç†é»˜è®¤æ–‡ä»¶ä¸ç¯å¢ƒé…ç½®<br>â€¢ ç¼–å†™ README æ–‡æ¡£ | Infinomat | âœ… å®Œæˆ |
| **P2** | 11.21 - 11.28 | **æ¡†æ¶ä¸åè®®è®¾è®¡** | â€¢ æ­å»ºæœåŠ¡ç«¯åˆå§‹åŒ–æ¡†æ¶ï¼ˆDBã€Userç±»ï¼‰<br>â€¢ åˆ¶å®šåˆæ­¥é€šä¿¡åè®®<br>â€¢ æ­å»ºæœåŠ¡ç«¯æ¶ˆæ¯æ¥æ”¶æ¡†æ¶ | PeterWinchester<br>Infinomat | âœ… å®Œæˆ |
| **P3** | 12.01 - 12.05 | **æ•°æ®åº“ä¸è®¤è¯ç³»ç»Ÿ** | â€¢ å»ºç«‹æ•°æ®åº“è¡¨ï¼ˆUsers, Friends, Messagesï¼‰<br>â€¢ å®ç°æ³¨å†Œã€ç™»å½•ï¼ˆå« Token ç™»å½•ï¼‰<br>â€¢ å®¢æˆ·ç«¯ç™»å½•æ¨¡å— UI ä¸é€»è¾‘ | PeterWinchester<br>quenquenwhynot<br>Infinomat | âœ… å®Œæˆ |
| **P4** | 12.06 - 12.08 | **åŸºç¡€æ¶ˆæ¯ä¸æœç´¢** | â€¢ æ¶ˆæ¯ç³»ç»ŸåŸºç¡€æ¡†æ¶å®Œæˆ<br>â€¢ å…¨å±€è”ç³»äººæœç´¢ä¸ç›‘å¬<br>â€¢ ç”¨æˆ·ä¿¡æ¯ä¸å¤´åƒæ˜¾ç¤º | Infinomat<br>Jsion-908<br>PeterWinchester | âœ… å®Œæˆ |
| **P5** | 12.10 - 12.11 | **ç¤¾äº¤å…³ç³»é“¾ç®¡ç†** | â€¢ å¥½å‹æ·»åŠ åŠŸèƒ½ï¼ˆè¯·æ±‚æ”¶å‘ã€çŠ¶æ€ç»´æŠ¤ï¼‰<br>â€¢ è”ç³»äººåˆ—è¡¨ä¼˜åŒ–ï¼ˆåœ¨çº¿çŠ¶æ€ã€è‡ªåŠ¨åˆ·æ–°ï¼‰<br>â€¢ ä¸ªäººèµ„æ–™ä¿®æ”¹ä¸å¤´åƒæ›´æ–°æœºåˆ¶ | PeterWinchester<br>Infinomat | âœ… å®Œæˆ |
| **P6** | 12.12 - 12.13 | **æ ¸å¿ƒèŠå¤©ä¸šåŠ¡** | â€¢ èŠå¤©æ¶ˆæ¯æ”¶å‘å®Œæ•´é€»è¾‘é—­ç¯<br>â€¢ æ¶ˆæ¯å·²è¯»æ ‡è®°ä¿®å¤<br>â€¢ é‚®ç®±éªŒè¯ä¿®å¤ | Infinomat<br>PeterWinchester | âœ… å®Œæˆ |
| **P7** | 12.18 | **æ–‡æ¡£ä¸æ”¶å°¾** | â€¢ æ–‡æ¡£ç»“æ„æ•´ç†<br>â€¢ é˜¶æ®µæ€§ä»£ç åˆå¹¶ | Infinomat | âœ… å®Œæˆ |

---

# 2. é¡¹ç›®è¿›åº¦ç”˜ç‰¹å›¾ (Mermaid)

```mermaid
gantt
    title CloudChat é¡¹ç›®å¼€å‘è¿›åº¦ç”˜ç‰¹å›¾ (2025)
    dateFormat  YYYY-MM-DD
    axisFormat  %m-%d
    excludes    weekends

    section åˆå§‹åŒ–é˜¶æ®µ
    é¡¹ç›®Init & ç¯å¢ƒé…ç½®       :done, init, 2025-11-14, 2025-11-15
    UIåˆæ­¥æ›´æ–°               :done, ui1, 2025-11-21, 1d

    section æ¶æ„ä¸åè®®
    æœåŠ¡ç«¯æ¡†æ¶æ­å»º           :done, server1, 2025-11-28, 2d
    é€šä¿¡åè®®åˆ¶å®š             :done, proto, 2025-11-28, 2025-12-03
    æ•°æ®åº“å»ºè¡¨               :done, db, 2025-12-01, 1d

    section æ ¸å¿ƒåŠŸèƒ½å¼€å‘
    æ³¨å†Œä¸ç™»å½•ä¸šåŠ¡           :done, auth, 2025-12-01, 2025-12-07
    æ¶ˆæ¯ç³»ç»ŸåŸºç¡€             :done, msg_base, 2025-12-06, 2d
    æœç´¢ä¸ç”¨æˆ·èµ„æ–™           :done, user_info, 2025-12-08, 2025-12-09

    section ç¤¾äº¤ä¸èŠå¤©ä¼˜åŒ–
    å¥½å‹æ·»åŠ ä¸çŠ¶æ€ç®¡ç†       :done, friends, 2025-12-10, 2025-12-11
    ç•Œé¢ä¿®å¤ä¸ä½“éªŒä¼˜åŒ–       :done, ui_fix, 2025-12-10, 2025-12-11
    å®Œæ•´èŠå¤©æ”¶å‘é€»è¾‘         :done, chat_full, 2025-12-12, 2025-12-13
    Bugä¿®å¤(é‚®ç®±/å·²è¯»)       :crit, bugfix, 2025-12-13, 1d

    section æ–‡æ¡£ä¸ç»´æŠ¤
    æ–‡æ¡£ç»“æ„æ•´ç†             :active, docs, 2025-12-18, 1d
```

# 4.æ•´ä½“æ¶æ„å›¾
```mermaid
graph TD
    %% å®šä¹‰èŠ‚ç‚¹æ ·å¼ï¼ˆç§»é™¤æœ«å°¾åˆ†å·ä»¥æé«˜å…¼å®¹æ€§ï¼‰
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef nginx fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef cpp fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef db fill:#fff3e0,stroke:#e65100,stroke-width:2px

    %% èŠ‚ç‚¹å®šä¹‰ï¼šæ³¨æ„æ–‡æœ¬éƒ½åŠ ä¸Šäº†åŒå¼•å·
    Client["å®¢æˆ·ç«¯ (æµè§ˆå™¨)"]:::client
    Nginx["Nginx åå‘ä»£ç† / é™æ€èµ„æº"]:::nginx
    Database[("MySQL æ•°æ®åº“<br/>ä¸»ä»å¤åˆ¶")]:::db

    %% åç«¯æœåŠ¡å­å›¾
    subgraph Backend_Service ["åç«¯æœåŠ¡ (C++)"]
        direction TB
        AccessLayer["<b>æ¥å…¥å±‚</b><br/>WebSocketæœåŠ¡<br/>å¤„ç†è¿æ¥å»ºç«‹ / å¿ƒè·³æ£€æµ‹"]:::cpp
        
        subgraph BusinessLayer ["ä¸šåŠ¡å±‚"]
            direction TB
            UserMod["ç”¨æˆ·æ¨¡å—<br/>ç™»å½•/æ³¨å†Œ/Token"]:::cpp
            ChatMod["èŠå¤©æ¨¡å—<br/>æ¶ˆæ¯è½¬å‘/å­˜å‚¨"]:::cpp
            FileMod["æ–‡ä»¶æ¨¡å—<br/>åˆ†ç‰‡ä¸Šä¼ /ä¸‹è½½"]:::cpp
            VideoMod["è§†é¢‘æ¨¡å—<br/>WebRTCä¿¡ä»¤è½¬å‘"]:::cpp
        end
        
        DataLayer["<b>æ•°æ®å±‚</b><br/>MySQLå®¢æˆ·ç«¯<br/>æ•°æ®è¯»å†™ / äº‹åŠ¡å¤„ç†"]:::cpp
    end

    %% è¿æ¥å…³ç³»
    Client <==> Nginx
    Nginx <==> AccessLayer
    AccessLayer <==> BusinessLayer
    BusinessLayer <==> DataLayer
    DataLayer <==> Database
```

# 5.æ•°æ®äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant C as å‰ç«¯ (Client)
    participant A as æ¥å…¥å±‚ (Access)
    participant B as ä¸šåŠ¡å±‚ (Business)
    participant D as æ•°æ®å±‚ (Data)
    participant SQL as MySQLæ•°æ®åº“

    Note over C, SQL: åœºæ™¯ç¤ºä¾‹ï¼šç”¨æˆ·å‘é€èŠå¤©æ¶ˆæ¯ (WebSocket)

    C->>A: 1. å‘é€æ¶ˆæ¯è¯·æ±‚ (WebSocket)
    activate A
    A->>A: è§£æè¯·æ±‚ç±»å‹
    A->>B: 2. è½¬å‘è‡³èŠå¤©æ¨¡å—
    activate B
    
    Note right of B: å¤„ç†ä¸šåŠ¡é€»è¾‘
    
    B->>D: 3. è¯·æ±‚å†™å…¥æ¶ˆæ¯è®°å½•
    activate D
    D->>SQL: æ‰§è¡Œ Insert SQL
    activate SQL
    SQL-->>D: è¿”å›æ‰§è¡Œç»“æœ
    deactivate SQL
    D-->>B: è¿”å›æˆåŠŸçŠ¶æ€
    deactivate D

    B-->>A: 4. ä¸šåŠ¡å¤„ç†å®Œæˆ
    deactivate B

    A-->>C: 5. è¿”å›ç¡®è®¤ / æ¨é€æ¶ˆæ¯
    deactivate A
```

# 6. ç³»ç»Ÿæ ¸å¿ƒä¸šåŠ¡å…¨é“¾è·¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    autonumber
    actor User as ç”¨æˆ·
    participant Browser as å‰ç«¯ (Angular)
    participant Nginx as Nginx (é™æ€èµ„æº)
    participant Server as åç«¯æœåŠ¡
    participant DB as æ•°æ®åº“

    %% é˜¶æ®µ1ï¼šåˆå§‹åŒ–
    Note over User, DB: 1. åˆå§‹åŒ–é˜¶æ®µ
    User->>Browser: æ‰“å¼€æµè§ˆå™¨è®¿é—®åœ°å€
    Browser->>Nginx: è¯·æ±‚é™æ€èµ„æº (HTML/JS/CSS)
    Nginx-->>Browser: è¿”å› Angular åº”ç”¨èµ„æº
    Browser->>Browser: åº”ç”¨åŠ è½½åˆå§‹åŒ–

    %% é˜¶æ®µ2ï¼šç™»å½•è®¤è¯
    Note over User, DB: 2. ç™»å½•ä¸è¿æ¥å»ºç«‹
    User->>Browser: è¾“å…¥è´¦å·å¯†ç ç‚¹å‡»ç™»å½•
    Browser->>Server: [HTTP] å‘é€ç™»å½•ä¿¡æ¯
    activate Server
    Server->>DB: éªŒè¯ç”¨æˆ·ä¿¡æ¯
    DB-->>Server: éªŒè¯é€šè¿‡
    Server-->>Browser: è¿”å›ç™»å½•æˆåŠŸ & JWT Token
    deactivate Server
    
    Browser->>Server: [WebSocket] æºå¸¦ Token å»ºç«‹è¿æ¥
    activate Server
    Server->>Server: éªŒè¯ Token æœ‰æ•ˆæ€§
    Server->>Server: ç»´æŠ¤ç”¨æˆ·è¿æ¥çŠ¶æ€ (Online)
    Server-->>Browser: è¿æ¥å»ºç«‹æˆåŠŸ
    deactivate Server

    %% é˜¶æ®µ3ï¼šæ¶ˆæ¯é€šä¿¡
    Note over User, DB: 3. èŠå¤©æ¶ˆæ¯äº¤äº’
    User->>Browser: å‘é€èŠå¤©æ¶ˆæ¯
    Browser->>Server: [WebSocket] å‘é€æ¶ˆæ¯æ•°æ®
    activate Server
    Server->>Server: è§£ææ¶ˆæ¯ç±»å‹ & ç¡®å®šæ¥æ”¶æ–¹
    par å¹¶è¡Œå¤„ç†
        Server->>DB: å­˜å‚¨æ¶ˆæ¯è®°å½•
        Server->>Browser: è½¬å‘æ¶ˆæ¯ç»™æ¥æ”¶æ–¹
    end
    deactivate Server

    %% é˜¶æ®µ4ï¼šè§†é¢‘é€šè¯
    Note over User, DB: 4. è§†é¢‘é€šè¯ (WebRTC)
    User->>Browser: å‘èµ·è§†é¢‘é€šè¯
    Browser->>Server: [WebSocket] å‘é€ SDP Offer
    Server->>Browser: è½¬å‘ä¿¡ä»¤ç»™å¯¹ç«¯
    Browser->>Server: [WebSocket] å‘é€ SDP Answer / ICE Candidate
    Server->>Browser: è½¬å‘åº”ç­”ä¿¡ä»¤
    Note right of Browser: åŒæ–¹æ ¹æ®ä¿¡ä»¤å»ºç«‹ P2P è¿æ¥
    Browser->>Browser: P2P è§†é¢‘æµä¼ è¾“ (ç›´æ¥é€šä¿¡/ä¸ç»åç«¯)

    %% é˜¶æ®µ5ï¼šé€€å‡º
    Note over User, DB: 5. ç”¨æˆ·é€€å‡º
    User->>Browser: å…³é—­é¡µé¢æˆ–ç‚¹å‡»é€€å‡º
    Browser->>Server: [WebSocket] å…³é—­è¿æ¥
    Server->>Server: æ¸…é™¤è¿æ¥çŠ¶æ€
    Server->>DB: æ›´æ–°ä¸ºâ€œç¦»çº¿â€çŠ¶æ€
```

# 7. å¼‚å¸¸å¤„ç†ä¸å¿ƒè·³æ£€æµ‹æµç¨‹å›¾

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef client fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef server fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px;

    subgraph Client_Side ["å‰ç«¯é€»è¾‘ (å®¢æˆ·ç«¯)"]
        direction TB
        Start((WebSocket<br>è¿æ¥æ–­å¼€)):::client --> RetryInit[åˆå§‹åŒ–é‡è¯•è®¡æ•°å™¨<br>Count = 0]:::client
        RetryInit --> CheckCount{Count < 3 ?}:::client
        
        CheckCount -- æ˜¯ --> Wait[ç­‰å¾… 5 ç§’]:::client
        Wait --> DoRetry[å°è¯•é‡æ–°è¿æ¥]:::client
        DoRetry --> IsSuccess{è¿æ¥æˆåŠŸ?}:::client
        
        IsSuccess -- æ˜¯ --> Reset[é‡ç½®è®¡æ•°å™¨<br>æ¢å¤æ­£å¸¸é€šä¿¡]:::client
        IsSuccess -- å¦ --> IncCount[Count + 1]:::client
        IncCount --> CheckCount
        
        CheckCount -- å¦ --> ShowError("æç¤ºç”¨æˆ·:<br>ç½‘ç»œå¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢"):::error
    end

    subgraph Server_Side ["åç«¯é€»è¾‘ (æœåŠ¡ç«¯)"]
        direction TB
        Listen[ç›‘å¬è¿æ¥çŠ¶æ€]:::server --> Heartbeat{æ£€æµ‹å¿ƒè·³åŒ…}:::server
        
        Heartbeat -- æ”¶åˆ°å¿ƒè·³ --> ResetTimer[é‡ç½®è¶…æ—¶è®¡æ—¶å™¨]:::server
        ResetTimer --> Listen
        
        Heartbeat -- æœªæ”¶åˆ° --> CheckTime{æ— å¿ƒè·³æ—¶é•¿<br>> 1åˆ†é’Ÿ ?}:::server
        CheckTime -- å¦ --> Listen
        CheckTime -- æ˜¯ --> CleanConn[è‡ªåŠ¨æ–­å¼€ Socket è¿æ¥]:::server
        CleanConn --> MarkOffline[æ ‡è®°æ•°æ®åº“çŠ¶æ€:<br>ç”¨æˆ·ç¦»çº¿]:::server
    end
```

 # 8. å‰ç«¯ä¸åç«¯å±‚æ¬¡ç»“æ„
 ## å‰ç«¯æ¶æ„å›¾
```mermaid
flowchart TB
    %% === æ ·å¼å®šä¹‰ ===
    classDef main fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef view fill:#fff3e0,stroke:#f57c00,stroke-width:2px;
    classDef component fill:#ffffff,stroke:#555,stroke-width:1px,stroke-dasharray: 5 5;
    classDef core fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    %% === 1. åº”ç”¨å…¥å£ä¸è·¯ç”± ===
    subgraph APP_BOOTSTRAP ["ğŸš€ Bootstrap Routing"]
        direction TB
        AppModule("AppModule (Root)"):::main
        AppRouting("AppRoutingModule"):::main
        AuthGuard("AuthGuard"):::main
        
        AppModule --> AppRouting
        AppRouting --> AuthGuard
    end

    %% === 2. è§†å›¾å±‚ (Pages & Layouts) ===
    subgraph VIEW_LAYER ["ğŸ–¥ï¸ View Layer (Pages & Components)"]
        direction LR

        %% å·¦ä¾§ï¼šè®¤è¯ç›¸å…³
        subgraph AUTH_PAGES ["Authentication"]
            direction TB
            Login["Login Page"]:::view
            Register["Register Page"]:::view
            Login -.-> Register
        end

        %% å³ä¾§ï¼šä¸»ä¸šåŠ¡ç›¸å…³
        subgraph MAIN_PAGES ["Main Application"]
            direction TB
            ChatLayout["Chat Layout (Container)"]:::view
            Settings["Settings Page"]:::view
            
            %% å†…éƒ¨ç»„ä»¶è¯¦æƒ…
            subgraph CHAT_COMPONENTS ["Layout Components"]
                direction TB
                Sidebar["Sidebar Component"]:::component
                ChatArea["Chat Area Component"]:::component
                ContactList["Contact List"]:::component
                AddContact["Add Contact Dialog"]:::component
            end
            
            ChatLayout --> Sidebar & ChatArea
            Sidebar --> ContactList & AddContact
        end

        %% è·¯ç”±æŒ‡å‘
        AuthGuard -- "Authorized" --> ChatLayout
        AuthGuard -- "Unauthorized" --> Login
    end

    %% === 3. æ ¸å¿ƒæœåŠ¡ä¸æ•°æ®å±‚ ===
    subgraph CORE_LAYER ["âš™ï¸ Core Layer (Services & Data)"]
        direction LR
        
        subgraph NETWORK ["Network & API"]
            direction TB
            SocketSvc["SocketService (WebSocket)"]:::core
            ReqSvc["RequestService (HTTP)"]:::core
        end

        subgraph STATE ["State & Logic"]
            direction TB
            AuthSvc["AuthService"]:::core
            MsgSvc["MessageService"]:::core
            ContactSvc["ContactService"]:::core
        end

        subgraph DATA ["Models & Protobuf"]
            direction TB
            Models["Data Models (User/Msg)"]:::core
            Protos["Proto Definitions"]:::core
        end

        %% ä¾èµ–å…³ç³»
        NETWORK --> STATE
        STATE --> DATA
    end

    %% === å±‚çº§è¿æ¥ ===
    VIEW_LAYER ==> STATE
    VIEW_LAYER -.-> Models
```
## åç«¯æ¶æ„å›¾
```mermaid
flowchart TB
    %% === æ ·å¼å®šä¹‰ ===
    classDef entry fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef logic fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;
    classDef data fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef db fill:#eceff1,stroke:#455a64,stroke-width:2px;

    %% === 1. ç½‘ç»œæ¥å…¥å±‚ ===
    subgraph NETWORK_LAYER ["ğŸŒ Network Access Layer"]
        direction TB
        
        subgraph ENTRY_POINT ["Entry Point"]
            direction LR
            Main["main() Server Start"]:::entry
            Signal["Signal Handler"]:::entry
            Main --> Signal
        end

        subgraph EVENT_HANDLERS ["WebSocket Event Loop"]
            direction LR
            OnOpen["OnOpen (Connect)"]:::entry
            OnMessage["OnMessage (Receive)"]:::entry
            OnClose["OnClose (Disconnect)"]:::entry
        end

        Main --> EVENT_HANDLERS
    end

    %% === 2. ä¸šåŠ¡é€»è¾‘å±‚ ===
    subgraph SERVICE_LAYER ["ğŸ§  Business Logic Layer (CloudChatService)"]
        direction TB
        
        Dispatcher("Request Dispatcher (Switch Case)"):::logic

        subgraph LOGIC_BLOCKS ["Functional Logic Blocks"]
            direction LR
            
            subgraph AUTH_LOGIC ["Auth & Session"]
                direction TB
                LoginFn[Login]:::logic
                RegisterFn[Register]:::logic
                LogoutFn[Logout]:::logic
            end

            subgraph USER_LOGIC ["User & Social"]
                direction TB
                UpdateFn[Update Profile]:::logic
                SearchFn[Search User]:::logic
                FriendFn[Add/Load Friends]:::logic
            end

            subgraph MSG_LOGIC ["Messaging"]
                direction TB
                SendFn[Send Message]:::logic
                LoadMsgFn[Load History]:::logic
                ReadFn[Mark Read]:::logic
            end
        end

        OnMessage ==> Dispatcher
        Dispatcher --> AUTH_LOGIC & USER_LOGIC & MSG_LOGIC
    end

    %% === 3. æ•°æ®æŒä¹…å±‚ ===
    subgraph DATA_LAYER ["ğŸ’¾ Data Persistence Layer"]
        direction LR
        
        subgraph MODULES ["Data Modules (DAO)"]
            UserMod[UserModule]:::data
            MsgMod[MsgModule]:::data
            GroupMod[GroupModule]:::data
            SysMod[Sys/Dat Module]:::data
        end

        MySQL[("MySQL Database")]:::db

        %% é€»è¾‘å±‚è°ƒç”¨æ•°æ®å±‚
        AUTH_LOGIC & USER_LOGIC --> UserMod
        MSG_LOGIC --> MsgMod
        MSG_LOGIC --> GroupMod
        
        %% æ•°æ®å±‚æ“ä½œæ•°æ®åº“
        MODULES <==> MySQL
    end
```

# 9.é¡¹ç›®æ¨¡å—ç»“æ„
## å‰ç«¯ UI ä¸è·¯ç”±ç»“æ„
```mermaid
flowchart TB
    %% æ ·å¼å®šä¹‰
    classDef module fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef page fill:#fff3e0,stroke:#f57c00,stroke-width:2px;
    classDef component fill:#ffffff,stroke:#555,stroke-width:1px,stroke-dasharray: 5 5;

    subgraph APP ["App Bootstrap"]
        direction TB
        AppModule("AppModule"):::module
        Routes("AppRoutingModule"):::module
        Guard("AuthGuard"):::module
        
        AppModule --> Routes
        Routes --> Guard
    end

    subgraph PAGES ["Pages & Layouts"]
        direction TB
        
        subgraph AUTH ["Authentication Pages"]
            direction LR
            Login["Login Page"]:::page
            Register["Register Page"]:::page
            Settings["Settings Page"]:::page
            ProfileUpdate["Profile Update"]:::page
        end

        subgraph CHAT ["Chat Interface"]
            direction TB
            ChatLayout["Chat Layout (Main Container)"]:::page
            
            subgraph COMPS ["Components"]
                Sidebar["Sidebar"]:::component
                ContactList["Contact List"]:::component
                AddContact["Add Contact Dialog"]:::component
                ChatArea["Chat Area"]:::component
            end
            
            ChatLayout --> Sidebar & ChatArea
            Sidebar --> ContactList
            ContactList -.-> AddContact
        end
    end

    %% è·¯ç”±æŒ‡å‘
    Guard -- "Allow" --> ChatLayout
    Guard -- "Block" --> Login
    Login -.-> Register
    Settings -.-> ProfileUpdate
```
## å‰ç«¯æ ¸å¿ƒé€»è¾‘æ¶æ„
```mermaid
flowchart LR
    %% æ ·å¼å®šä¹‰
    classDef net fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef biz fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef model fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;

    subgraph SERVICES ["Services (Dependency Injection)"]
        direction TB
        
        subgraph NET_LAYER ["Network Layer"]
            SocketSvc["SocketService"]:::net
            ReqSvc["RequestService"]:::net
            SocketSvc <--> ReqSvc
        end

        subgraph BIZ_LAYER ["Business Layer"]
            AuthSvc["AuthService"]:::biz
            MsgSvc["MessageService"]:::biz
            ContactSvc["ContactService"]:::biz
            FriendReqSvc["FriendRequestService"]:::biz
        end
    end

    subgraph MODELS ["Data Models & Protocols"]
        direction TB
        UserModel["User / Contact Model"]:::model
        MsgModel["Message Model"]:::model
        FriendReqModel["FriendRequest Model"]:::model
        Proto["Protocols (ProtoBuf)"]:::model
    end

    %% ä¾èµ–å…³ç³»
    NET_LAYER --> BIZ_LAYER
    BIZ_LAYER -.-> MODELS
    
    %% å…·ä½“æœåŠ¡ä¾èµ–
    ReqSvc --> AuthSvc
    AuthSvc --> MsgSvc
    MsgSvc --> ContactSvc
    ContactSvc --> FriendReqSvc
```
## åç«¯æœåŠ¡ç«¯æ ¸å¿ƒ
```mermaid
flowchart TB
    %% æ ·å¼å®šä¹‰
    classDef core fill:#eceff1,stroke:#455a64,stroke-width:2px;
    classDef event fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;

    subgraph SERVER_LIFECYCLE ["Server Lifecycle"]
        direction TB
        
        Main["main() Entry Point"]:::core
        
        subgraph SIGNAL_HANDLING ["System Signals"]
            Signal["signal_handler (SIGINT/SIGTERM)"]:::core
        end

        subgraph EVENT_LOOP ["WebSocket Event Loop"]
            direction TB
            OnOpen["OnOpen (New Connection)"]:::event
            OnMessage["OnMessage (Data Received)"]:::event
            OnClose["OnClose (Disconnect)"]:::event
        end

        Main --> Signal
        Main --> EVENT_LOOP
    end

    subgraph DISPATCH ["Message Dispatcher"]
        Service["CloudChatService::Process"]:::core
        OnMessage ==> Service
    end
```
## åç«¯ä¸šåŠ¡ä¸æ•°æ®æ¨¡å—
```mermaid
flowchart LR
    %% æ ·å¼å®šä¹‰
    classDef service fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px;
    classDef data fill:#e0f7fa,stroke:#006064,stroke-width:2px;

    subgraph CLOUD_SERVICE ["CloudChatService"]
        direction TB
        
        subgraph AUTH_OPS ["Authentication"]
            Login["Login"]:::service
            Register["Register"]:::service
            Logout["Logout"]:::service
            UpdateProfile["UpdateProfile"]:::service
        end

        subgraph CONTACT_OPS ["Contact Management"]
            LoadContacts["LoadContacts"]:::service
            AddContact["AddContact"]:::service
            Search["Search User (ID/Name)"]:::service
            FriendReq["Handle Friend Request"]:::service
        end

        subgraph MSG_OPS ["Messaging"]
            LoadMsg["LoadHistory"]:::service
            SendMsg["SendMessage (Text/Img/File)"]:::service
            MarkRead["MarkRead"]:::service
        end
    end

    subgraph DATA_ACCESS ["Data Access Layer (DAO)"]
        direction TB
        UserMod["UserModule (User Table)"]:::data
        MsgMod["MsgModule (Message Table)"]:::data
        GroupMod["GroupModule"]:::data
        DatMod["DatModule (DB Connection)"]:::data
        SysMod["SysModule (Utils)"]:::data
        
        %% æ¨¡å—é—´ä¾èµ–
        UserMod & MsgMod & GroupMod --> DatMod
    end

    %% ä¸šåŠ¡è°ƒç”¨æ•°æ®
    AUTH_OPS --> UserMod
    CONTACT_OPS --> UserMod
    MSG_OPS --> MsgMod
    
    %% åŸºç¡€æ”¯æŒ
    CLOUD_SERVICE -.-> SysMod
```
# 10.æ¨¡å—è¯¦ç»†åŠŸèƒ½
## å®¢æˆ·ç«¯
### AppModule
```mermaid
flowchart LR
  subgraph æ ¹æ¨¡å— AppModule
    in[è¾“å…¥: å¯åŠ¨å‚æ•° / ç¯å¢ƒé…ç½® / è·¯ç”±å®šä¹‰] --> proc(å¤„ç†: åˆå§‹åŒ–åº”ç”¨ã€æ³¨å†Œè·¯ç”±ã€æ³¨å…¥æœåŠ¡)
    proc --> out[è¾“å‡º: æ ¹ç»„ä»¶å®ä¾‹ / è·¯ç”±è¡¨ / æœåŠ¡å•ä¾‹]
  end
```
### é¡µé¢ä¸å¸ƒå±€
```mermaid
flowchart LR
  subgraph é¡µé¢ä¸å¸ƒå±€
    in[è¾“å…¥: ç”¨æˆ·äº¤äº’ / è·¯ç”±å¯¼èˆª / API æ•°æ®] --> proc(å¤„ç†: æ¸²æŸ“è§†å›¾ã€è¡¨å•éªŒè¯ã€äº‹ä»¶ä¼ æ’­)
    proc --> out[è¾“å‡º: UI æ›´æ–° / ç”¨æˆ·æ“ä½œäº‹ä»¶ / è¯·æ±‚è°ƒç”¨]
  end
```
### SocketService
```mermaid
flowchart LR
  subgraph SocketService
    in[è¾“å…¥: æœåŠ¡å™¨ WS æ¶ˆæ¯ / å®¢æˆ·ç«¯æ¶ˆæ¯è¯·æ±‚] --> proc(å¤„ç†: å»ºè¿ã€ç¼–ç /è§£ç ã€å¿ƒè·³ã€é‡è¿)
    proc --> out[è¾“å‡º: äº‹ä»¶å›è°ƒ / è½¬å‘ç»™ MessageService æˆ–å…¶ä»–æœåŠ¡]
  end
```
### RequestService
```mermaid
flowchart LR
  subgraph RequestService
    in[è¾“å…¥: å‰ç«¯ HTTP è¯·æ±‚] --> proc(å¤„ç†: å‘èµ· REST/HTTPã€å¤„ç†å“åº”ã€é”™è¯¯é‡è¯•)
    proc --> out[è¾“å‡º: API å“åº” / é”™è¯¯ä¿¡æ¯]
  end
```
### AuthService
```mermaid
flowchart LR
  subgraph AuthService
    in[è¾“å…¥: å‡­è¯ / Token / ç™»å½•è¯·æ±‚] --> proc(å¤„ç†: éªŒè¯å‡­è¯ã€ä¿å­˜ tokenã€ç”¨æˆ·çŠ¶æ€ç®¡ç†)
    proc --> out[è¾“å‡º: ç™»å½•ç»“æœ / ç”¨æˆ·ä¼šè¯çŠ¶æ€ / Token]
  end
```
### MessageService
```mermaid
flowchart LR
  subgraph MessageService
    in[è¾“å…¥: ç”¨æˆ·å‘é€æ¶ˆæ¯ / æ¥æ”¶æœåŠ¡å™¨æ¶ˆæ¯] --> proc(å¤„ç†: æ’é˜Ÿã€æ ¼å¼åŒ–ã€æŒä¹…åŒ–è¯·æ±‚ã€æ›´æ–°æœ¬åœ°çŠ¶æ€)
    proc --> out[è¾“å‡º: å‘å¾€ Socket / æ›´æ–° UI / æœ¬åœ°æ¶ˆæ¯è®°å½•]
  end
```
### ContactService
```mermaid
flowchart LR
  subgraph ContactService
    in[è¾“å…¥: åŠ è½½è”ç³»äººè¯·æ±‚ / æ·»åŠ /åˆ é™¤è”ç³»äººå‘½ä»¤] --> proc(å¤„ç†: è°ƒç”¨ APIã€æ›´æ–°æœ¬åœ°è”ç³»äººåˆ—è¡¨)
    proc --> out[è¾“å‡º: è”ç³»äººåˆ—è¡¨ / æ“ä½œç»“æœ / é€šçŸ¥ UI]
  end
```
### Models & Protocols
```mermaid
flowchart LR
  subgraph Models & Protocols
    in[è¾“å…¥: åŸå§‹ JSON / è¡¨å•æ•°æ® / äºŒè¿›åˆ¶] --> proc(å¤„ç†: åºåˆ—åŒ–/ååºåˆ—åŒ–ã€ç±»å‹æ ¡éªŒã€è½¬æ¢ä¸ºå†…éƒ¨æ¨¡å‹)
    proc --> out[è¾“å‡º: User/Message/FriendRequest å¯¹è±¡ / åè®®æ¶ˆæ¯ payload]
  end
```
## æœåŠ¡ç«¯
### main/äº‹ä»¶å›è·¯
```mermaid
flowchart LR
  subgraph main/äº‹ä»¶å›è·¯
    in[è¾“å…¥: å¯åŠ¨é…ç½® / ç½‘ç»œè¿æ¥è¯·æ±‚] --> proc(å¤„ç†: å¯åŠ¨æœåŠ¡ã€ç›‘å¬ WSã€æ³¨å†Œä¿¡å·å¤„ç†)
    proc --> out[è¾“å‡º: å¯ç”¨ WS æœåŠ¡å™¨ / äº‹ä»¶å¾ªç¯]
  end
```
### OnMessage -> Dispatcher
```mermaid
flowchart LR
  subgraph OnMessage - Dispatcher
    in[è¾“å…¥: WS æ¶ˆæ¯ JSON/Protocol] --> proc(å¤„ç†: è§£ææ¶ˆæ¯ã€è·¯ç”±åˆ° CloudChatService çš„ç›¸åº”å¤„ç†å‡½æ•°)
    proc --> out[è¾“å‡º: å“åº”æ¶ˆæ¯ / å¹¿æ’­é€šçŸ¥ / DB æ“ä½œè¯·æ±‚]
  end
```
### Service - Auth
```mermaid
flowchart LR
  subgraph Service - Auth
    in[è¾“å…¥: ç™»å½•/æ³¨å†Œ/Token] --> proc(å¤„ç†: æ ¡éªŒã€DB æŸ¥è¯¢/å†™å…¥ã€ç”Ÿæˆ tokenã€ç»´æŠ¤åœ¨çº¿æ˜ å°„)
    proc --> out[è¾“å‡º: éªŒè¯ç»“æœ / ç”¨æˆ·ä¿¡æ¯ / Token / æ¨é€é€šçŸ¥]
  end
```
### Service - Contacts/Message
```mermaid
flowchart LR
  subgraph Service - Contacts/Message
    in[è¾“å…¥: åŠ è½½è”ç³»äºº / å‘é€æ¶ˆæ¯ / æ–‡ä»¶/å›¾ç‰‡] --> proc(å¤„ç†: DB æ“ä½œã€æ¶ˆæ¯æŒä¹…åŒ–ã€è·¯ç”±/æ¨é€åˆ°åœ¨çº¿ç”¨æˆ·)
    proc --> out[è¾“å‡º: è”ç³»äººæ•°æ® / å‘é€ç¡®è®¤ / å³æ—¶æ¨é€]
  end
```
### CloudChatDat (DB è®¿é—®)
```mermaid
flowchart LR
  subgraph CloudChatDat DB è®¿é—®
    in[è¾“å…¥: SQL è¯·æ±‚ / æŸ¥è¯¢å‚æ•°] --> proc(å¤„ç†: æ„é€ æŸ¥è¯¢ã€æ‰§è¡Œã€ç»“æœæ˜ å°„)
    proc --> out[è¾“å‡º: è®°å½•é›† / å—å½±å“è¡Œæ•° / é”™è¯¯ç ]
  end
```

# 11.æ¨¡å—è¯¦ç»†åˆ†æå›¾
## ç™»å½•æ¨¡å—
### ç¨‹åºæµç¨‹å›¾
```mermaid
flowchart TD
  Start([å¼€å§‹])
  A[æ¥æ”¶å‡­è¯ username,password]
  B{è¾“å…¥åˆæ³•?}
  C[æŸ¥è¯¢ç”¨æˆ·è®°å½• DB]
  D{ç”¨æˆ·å­˜åœ¨?}
  E{è´¦æˆ·æ¿€æ´»?}
  F{å¯†ç åŒ¹é…?}
  G[ç”Ÿæˆ token, æ›´æ–°åœ¨çº¿æ˜ å°„]
  H[è¿”å›æˆåŠŸå“åº” user, token]
  I[è¿”å›å¤±è´¥å“åº” é”™è¯¯æ¶ˆæ¯]
  End([ç»“æŸ])

  Start --> A --> B
  B -- å¦ --> I
  B -- æ˜¯ --> C --> D
  D -- å¦ --> I
  D -- æ˜¯ --> E
  E -- å¦ --> I
  E -- æ˜¯ --> F
  F -- å¦ --> I
  F -- æ˜¯ --> G --> H --> End
```
### åˆ¤å®šè¡¨ï¼ˆæ ¸å¿ƒåˆ¤å®šï¼‰
|æ¡ä»¶ç¼–å·   |ç”¨æˆ·å­˜åœ¨|è´¦æˆ·æ¿€æ´»|å¯†ç åŒ¹é…|ç»“æœ                    |
| :---      | :---  | :---  | :---  | :---                      |
|C1         |å¦     |â€”      |â€”      |è¿”å› "user not found"  |		 
|C2         |æ˜¯     |å¦     |	â€”   |è¿”å› "account inactive"    |
|C3         |æ˜¯	    |æ˜¯	    |å¦	    |è¿”å› "invalid credential"  |
|C4	        |æ˜¯	    |æ˜¯	    |æ˜¯	    |ç”Ÿæˆ tokenï¼Œè¿”å›æˆåŠŸ       |

## æ¶ˆæ¯æ¨¡å—
### N-Så›¾
```mermaid
flowchart TB
  subgraph SendMsgBox["SendMessage æ¨¡å—"]
    direction TB
    IN["è¾“å…¥: senderId,targetId,payload,type"]
    VALID["æ ¡éªŒ payload/type"]
    PERSIST["æŒä¹…åŒ–: å†™å…¥ DB (pending)"]
    ROUTE["è·¯ç”±å†³ç­–: ç›®æ ‡åœ¨çº¿?"]
    PUSH["æ¨é€æˆ–æ’é˜Ÿ(offline)"]
    ACK["è¾“å‡º: å‘é€ç¡®è®¤ ACK"]
  end
  IN --> VALID --> PERSIST --> ROUTE --> PUSH --> ACK
```
### åˆ¤å®šè¡¨
|æ¡ä»¶|	Payload åˆæ³•|	æ¥æ”¶æ–¹åœ¨çº¿	|æ“ä½œ|
| :---  | :---  | :---  | :---  |
|R1	|   å¦      |	ä»»æ„	|è¿”å›é”™è¯¯ï¼Œä¸å†™ DBï¼ˆæˆ–å†™å¤±è´¥è®°å½•ï¼‰|
|R2	|   æ˜¯      |    æ˜¯	    |å†™ DB -> ç«‹å³æ¨é€ -> æ›´æ–°çŠ¶æ€ä¸º delivered|
|R3	|   æ˜¯     |	å¦	    |å†™ DB -> æ”¾å…¥ç¦»çº¿é˜Ÿåˆ— -> çŠ¶æ€ pending/sent|
## å¥½å‹è¯·æ±‚æ¨¡å—
### PDLä»£ç 
```text
AddFriendRequest(fromId,toId,remark)
  IF fromId == toId THEN
    RETURN error("cannot add yourself")
  ENDIF

  IF NOT DB.UserExists(toId) THEN
    RETURN error("target not found")
  ENDIF

  IF DB.AreFriends(fromId,toId) THEN
    RETURN error("already friends")
  ENDIF

  IF DB.PendingRequestExists(fromId,toId) THEN
    RETURN error("request already pending")
  ENDIF

  reqId = DB.InsertFriendRequest(fromId,toId,remark,status="pending")
  NotifyUser(toId, BuildFriendRequestPayload(reqId,...))
  RETURN success({requestId:reqId})
END
```
### PAD å›¾
```mermaid
flowchart LR
  Inputs["è¾“å…¥: å‘èµ·è€…ID, ç›®æ ‡ID, é™„è¨€"]
  Process["å¤„ç†: éªŒè¯ç›®æ ‡ -> æ£€æŸ¥å…³ç³» -> å†™è¯·æ±‚ -> é€šçŸ¥"]
  Outputs["è¾“å‡º: è¯·æ±‚è®°å½•ID / é”™è¯¯ä¿¡æ¯ / é€šçŸ¥äº‹ä»¶"]
  Inputs --> Process --> Outputs
```
### åˆ¤å®šè¡¨
|æ¡ä»¶|	ç›®æ ‡å­˜åœ¨|	æ˜¯å¦è‡ªå·±|	å·²ä¸ºå¥½å‹|	å·²æœ‰ pending è¯·æ±‚|	ç»“æœ|
| :---| :---  | :---  | :---        | :---          | :---  |
|P1	|   å¦  	|   ä»»æ„	|   ä»»æ„	|       ä»»æ„	    |è¿”å› "target not found"|
|P2	|   æ˜¯  	|   æ˜¯	    |   ä»»æ„	|       ä»»æ„	    |è¿”å› "cannot add yourself"|
|P3	|   æ˜¯  	|   å¦	    |   æ˜¯	    |       ä»»æ„	    |è¿”å› "already friends"|
|P4	|   æ˜¯  	|   å¦	    |   å¦	    |       æ˜¯	        |è¿”å› "request already pending"|
|P5	|   æ˜¯  	|   å¦	    |   å¦	    |       å¦	        |æ’å…¥è¯·æ±‚ -> é€šçŸ¥ç›®æ ‡ -> è¿”å› success|

# 12.æ¨¡å—å±‚æ¬¡å›¾
## AppModule å‰ç«¯é¡¶å±‚
```mermaid
flowchart TD
  AppParent["Browser / Runtime"]
  App["AppModule (App)"]
  Children["Pages / Layout / Services / Models"]
  AppParent --> App --> Children
```
- å‚æ•°ä¸è°ƒç”¨ï¼š
    è·¯ç”±ï¼šroutes æ³¨å…¥åˆ° AppModuleï¼Œè°ƒç”¨ï¼šAngular è·¯ç”±å™¨ navigate()

    åˆå§‹åŒ–ï¼šappConfig æ³¨å…¥ï¼Œæ‰§è¡Œ App.init()ï¼ˆæ— å‚æ•°æˆ– envï¼‰

- ç›´æ¥å…³è”æ•°æ®ç»“æ„ï¼š
    å†…å­˜ï¼šcurrentUserï¼ˆUser modelï¼‰

    æœ¬åœ°å­˜å‚¨ï¼šauth_tokenï¼ˆlocalStorage / cookieï¼‰

## ChatLayout é¡µé¢å¸ƒå±€
```mermaid
flowchart TD
  Parent["AppModule"] --> ChatLayout["ChatLayoutComponent"]
  ChatLayout --> Sidebar
  ChatLayout --> ChatArea
  ChatLayout --> ContactList
```
- å‚æ•°/è°ƒç”¨ï¼š
    è¾“å…¥ props: activeConversationId, currentUser

    äº‹ä»¶ï¼šonSelectContact(contactId) è°ƒç”¨ MessageService.loadMessages(contactId)

- å…³è”æ•°æ®ç»“æ„ï¼š
    UI state: activeConversationï¼ˆMessage[]ï¼‰

    ä»åç«¯ï¼šContacts list (contacts[])

## Sidebar / ContactListç»„ä»¶
```mermaid
flowchart TB
  ChatLayout --> Sidebar --> ContactList --> AddContact
```
- å‚æ•°/è°ƒç”¨ï¼š
    ContactService.loadContacts(userId, page) â†’ HTTP/WS è¯·æ±‚

    ContactList.select(contactId) å‘å‡ºäº‹ä»¶ç»™çˆ¶ç»„ä»¶

- æ•°æ®ç»“æ„ï¼š
    Contact model: {id, username, avatar, status}

    DB è¡¨ï¼ˆåç«¯å¯¹åº”ï¼‰ï¼šusers, friends

## SocketServiceï¼ˆå‰ç«¯ WebSocket é€šä¿¡ï¼‰
```mermaid
flowchart TB
  AppModule --> SocketService["SocketService"]
  SocketService --> MessageService
  SocketService --> ResponseService
```
- å‚æ•°/è°ƒç”¨ï¼š
    è¿æ¥ï¼šSocketService.connect(url, token)

    å‘é€ï¼šSocketService.send({type, payload, temp_id})

    å›è°ƒï¼šonMessage(msg) -> dispatch to ResponseService

- æ•°æ®ç»“æ„ï¼š
    WS æ¶ˆæ¯æ ¼å¼ï¼ˆClientProtocolï¼‰ï¼š{type: ClientMessageType, payload: {...}}

    æœ¬åœ°é˜Ÿåˆ—ï¼špendingMessagesï¼ˆç”¨äºé‡è¯•/ACK å¯¹ç…§ï¼‰

## MessageServiceï¼ˆå‰ç«¯ æ¶ˆæ¯ç®¡ç†ï¼‰
```mermaid
flowchart TB
  Services["Services"] --> MessageService["MessageService"]
  MessageService --> SocketService
  MessageService --> RequestService
```
- å‚æ•°/è°ƒç”¨ï¼š
    sendMessage(targetId, content, type) -> æ„å»º payloadã€è°ƒç”¨ SocketService.send()

    loadMessages(targetId, page) -> RequestService.get('/messages', {targetId,page})

- æ•°æ®ç»“æ„ï¼š
    Message model: {id, temp_id, senderId, receiverId, content, type, status, ts}

    æœ¬åœ° DB/cache: messagesByConversation: Map<conversationId, Message[]>

## AuthServiceï¼ˆå‰ç«¯ è®¤è¯ï¼‰
```mermaid
flowchart TB
  AppModule --> AuthService["AuthService"]
  AuthService --> SocketService
  AuthService --> RequestService
```
- å‚æ•°/è°ƒç”¨ï¼š
    login(username,password) -> RequestService.post('/auth/login', {username,password})

    store token: localStorage.setItem('token', token)

    attach token: RequestService.setHeader('Authorization','Bearer '+token)

- æ•°æ®ç»“æ„ï¼š
    User model: {id, username, avatar, email}

    Session token (JWT or token string)

# 13.å­˜å‚¨åˆ†é…æ–¹æ¡ˆ
## å­˜å‚¨åˆ†é…è¡¨

| æ¨¡å— | å­˜å‚¨ç±»å‹ | ç”¨é€” | å»ºè®®åˆ†é…/ä¸Šé™ | ä¿ç•™/æ·˜æ±°ç­–ç•¥ | ä½ç½® / ç¤ºä¾‹ |
|---|---|---|---:|---|---|
| å‰ç«¯ï¼šæµè§ˆå™¨ç¼“å­˜ (`AppModule`) | localStorage / sessionStorage / IndexedDB | ç¼“å­˜ç”¨æˆ·ä¼šè¯ã€UI çŠ¶æ€ã€ç¦»çº¿æ¶ˆæ¯ç¼“å­˜ | token < 4KBï¼›UI cache æ€»è®¡ < 5MB | token ä¿ç•™ç›´åˆ°ç™»å‡ºï¼›UI ç¼“å­˜æŒ‰ LRU ä¸¢å¼ƒ | æµè§ˆå™¨ localStorage / IndexedDB |
| å‰ç«¯ï¼šæ¶ˆæ¯çŸ­æœŸç¼“å­˜ (`MessageService`) | å†…å­˜ + IndexedDB | å½“å‰ä¼šè¯æ¶ˆæ¯ã€æ»šåŠ¨ç¼“å†² | å•ä¼šè¯ç¼“å­˜ 200â€“1000 æ¡ï¼ˆ100KBâ€“2MBï¼‰ | æœ€è¿‘ä½¿ç”¨ä¼˜å…ˆï¼Œè¶…å‡ºæŒä¹…åŒ–åˆ° IndexedDB | IndexedDB / å†…å­˜å¯¹è±¡ |
| å‰ç«¯ï¼šä¸Šä¼ åˆ†ç‰‡ä¸´æ—¶ | æµè§ˆå™¨å†…å­˜ / ä¸´æ—¶å¯¹è±¡ | å­˜æ”¾ä¸Šä¼ åˆ†ç‰‡ | å•ç”¨æˆ·ä¸´æ—¶ä¸Šé™ 100MBï¼ˆå¯é…ç½®ï¼‰ | ä¸Šä¼ æˆåŠŸååˆ é™¤ï¼Œè¶…æ—¶æ¸…ç† | æµè§ˆå™¨ä¸´æ—¶å¯¹è±¡ |
| Socket å±‚ (æœåŠ¡ç«¯) | è¿›ç¨‹å†…å­˜ (map) | è¿æ¥å¥æŸ„æ˜ å°„ã€æœªç¡®è®¤æ¶ˆæ¯é˜Ÿåˆ— | è¿æ¥æ•° Ã— ~200Bï¼›100k è¿æ¥ â‰ˆ 20MB | è¿æ¥æ–­å¼€é‡Šæ”¾ï¼Œpending æŒä¹…åŒ– | æœåŠ¡è¿›ç¨‹å†…å­˜ï¼›`g_online_users` |
| æ¶ˆæ¯æŒä¹…åŒ– (`messages`) | å…³ç³»å‹ DB (MySQL) + ç¼“å­˜ (Redis) | æŒä¹…åŒ–èŠå¤©è®°å½•ã€çŠ¶æ€ã€ç¦»çº¿é˜Ÿåˆ— | å•æ¶ˆæ¯ ~1â€“10KBï¼›1M æ¡ â‰ˆ 1â€“10GBï¼›Redis ç¼“å­˜ 1â€“10GB | DB é•¿æœŸä¿ç•™ï¼ŒRedis TTL 1â€“7 å¤© | MySQL `messages` è¡¨ï¼›Redis `conv:{id}` |
| è®¤è¯/ä¼šè¯ (`AuthService`) | DB (users) + Redis + Secrets | ç”¨æˆ·è®°å½•ã€token é»‘åå•ã€ä¼šè¯çŠ¶æ€ | users è¡¨è¡Œ ~<1KBï¼›100k ç”¨æˆ· â‰ˆ100MBï¼›token ç¼“å­˜ 1â€“5GB | token è¿‡æœŸåç§»é™¤ï¼Œå†å²å­˜æ¡£ | MySQL `users`ï¼›Redis `session:{token}`ï¼›Vault |
| åç«¯è¿è¡Œæ—¶ | è¿›ç¨‹å†…å­˜ / æœ¬åœ°ç£ç›˜ | è¿æ¥ã€ç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ | ä¾å¹¶å‘ï¼ŒæœåŠ¡è¿›ç¨‹å»ºè®® 2â€“4GB å¯ç”¨å†…å­˜ | è¿›ç¨‹é‡å¯é‡Šæ”¾ | æœåŠ¡ä¸»æœºå†…å­˜ / /var/tmp |
| ä¸šåŠ¡æœåŠ¡ç¼“å­˜/é˜Ÿåˆ— | å†…å­˜ + æ¶ˆæ¯é˜Ÿåˆ— (Rabbit/Kafka) | ç¦»çº¿é˜Ÿåˆ—ã€çŸ­æœŸç¼“å­˜ã€ä»»åŠ¡é˜Ÿåˆ— | å†…å­˜ 100MBâ€“1GBï¼›é˜Ÿåˆ—æŒ‰åå | é˜Ÿåˆ—æŒä¹…åŒ–åˆ°æ¶ˆæ¯ç³»ç»Ÿï¼Œå†…å­˜ä»…ç¼“å­˜ | Redis / RabbitMQ / Kafka |
| æ•°æ®è®¿é—®å±‚ (`cloudchatdat`) | MySQLï¼ˆä¸»/ä»ï¼‰ | å­˜å‚¨è¡¨ï¼šusersã€friendsã€messagesã€filesã€friend_requests | DB æ€»é‡æŒ‰æ¶ˆæ¯å’Œæ–‡ä»¶ä¼°ç®—ï¼ˆè§ä¸‹ï¼‰ | åˆ†åŒº/å½’æ¡£ç­–ç•¥ | MySQL å®ä¾‹ï¼Œå»ºè®®ä¸»ä»å¤‡ä»½ |
| ç”¨æˆ·æ¨¡å‹ (`cloudchatuser`) | DB è¡Œ + å†…å­˜ | ç”¨æˆ·å­—æ®µã€tokenã€åœ¨çº¿çŠ¶æ€ | æ¯ç”¨æˆ· ~0.5â€“2KB | éšç§åˆ é™¤/è„±æ• | MySQL `users` |
| æ–‡ä»¶å­˜å‚¨ï¼ˆä¸Šä¼ /æŒä¹…ï¼‰ | å¯¹è±¡å­˜å‚¨ (S3/MinIO) + ä¸´æ—¶ç£ç›˜ | å­˜å‚¨å›¾ç‰‡/é™„ä»¶/åª’ä½“ | å•æ–‡ä»¶ä¸Šé™ 50MBï¼ˆå¯é…ç½®ï¼‰ï¼›åˆå§‹é¢„ç•™ 100GB | åˆ†ç‰‡çŸ­æœŸ 24â€“72h æ¸…ç†ï¼›æ–‡ä»¶æœ¬èº«æ ¹æ®ç­–ç•¥ä¿ç•™ | S3 bucket æˆ–æœ¬åœ° `public/avatar/` |
| æ–‡ä»¶å…ƒæ•°æ® (`files`) | MySQL è¡¨ | å…ƒæ•°æ®ï¼šfileIdã€pathã€mimeã€sizeã€hashã€owner | æ¯æ¡ <1KBï¼›10ä¸‡æ–‡ä»¶ â‰ˆ100MB | åˆ é™¤åŒæ­¥ç‰©ç†æ–‡ä»¶ | MySQL `files` |
| å¥½å‹è¯·æ±‚ (`friend_requests`) | MySQL è¡¨ | è¯·æ±‚çŠ¶æ€ã€æ—¶é—´æˆ³ | æ¯æ¡ <1KBï¼›100k è¯·æ±‚ â‰ˆ100MB | å¤„ç†åå¯ä¿ç•™æˆ–å½’æ¡£ | MySQL `friend_requests` |
| æ—¥å¿— | æœ¬åœ°æ–‡ä»¶ / æ—¥å¿—ç³»ç»Ÿ (ELK) | è®¿é—®æ—¥å¿—ã€é”™è¯¯ã€ä¸šåŠ¡æ—¥å¿— | æ—¥é€Ÿç‡ Ã— ä¿ç•™æœŸï¼›å»ºè®®è‡³å°‘ 10GB æ—¥èµ· | æ—¥å¿—è½®è½¬ã€å‹ç¼©ã€7â€“30 å¤©çƒ­å­˜ | /var/log/cloudchat/*.logï¼›ELK |
| å®¡è®¡ | å…³ç³» DB / ä¸“ç”¨å®¡è®¡åº“ | å…³é”®æ“ä½œå®¡è®¡è®°å½• | ç»“æ„åŒ–è®°å½• ~0.5â€“2KB/æ¡ | é•¿æœŸä¿å­˜åŠ å¯†ï¼Œè®¿é—®å—é™ | MySQL audit è¡¨æˆ–ä¸“åº“ |
| æŒ‡æ ‡/ç›‘æ§ | æ—¶åº DB (Prometheus) | QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ | é‡‡æ ·ä¸ä¿ç•™æœŸå½±å“å®¹é‡ | çƒ­æ•°æ® 15â€“90 å¤©ï¼Œå†å²å½’æ¡£ | Prometheus + Grafana |
| ä¸´æ—¶/ç¼“å­˜ | Redis | ä¼šè¯ã€rate-limitã€ä¸Šä¼ ä¼šè¯ | Redis 1â€“10GB | TTL ç­–ç•¥ | Redis å®ä¾‹ |
| é…ç½®/å¯†é’¥ | Vault / ç¯å¢ƒå˜é‡ | DB å¯†ç ã€API keyã€JWT secret | å°‘é‡ | å®šæœŸè½®æ¢ | HashiCorp Vault / K8s Secrets |

---

## å®¹é‡ä¼°ç®—ä¸è°ƒæ•´åŸåˆ™
- æ¶ˆæ¯å®¹é‡ä¼°ç®—ï¼š
  - å…¬å¼ï¼šæ¶ˆæ¯æ•° Ã— å¹³å‡æ¶ˆæ¯å¤§å°ï¼ˆå«ç´¢å¼•å¼€é”€ï¼‰ã€‚ç¤ºä¾‹ï¼š100k ç”¨æˆ· Ã— å¹³å‡ 0.5 æ¡/æ—¥ Ã— 365 å¤© Ã— 1KB â‰ˆ 18.25GB/å¹´ã€‚
- æ–‡ä»¶å­˜å‚¨ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆS3/MinIOï¼‰æ”¯æŒåˆ†å±‚ï¼ˆçƒ­/å†·ï¼‰ï¼Œæ›´ç»æµä¸”æ˜“æ‰©å±•ã€‚
- ç¼“å­˜ä¸å†…å­˜ï¼šRedis ç”¨äºä¼šè¯ä¸çƒ­æ•°æ®ï¼Œå®¹é‡æŒ‰æ´»è·ƒç”¨æˆ·ä¸ key å¤§å°ä¼°ç®—ã€‚
- å¤§è¡¨ç­–ç•¥ï¼š`messages`ã€`files` å»ºè®®æŒ‰æ—¶é—´/ä¼šè¯åˆ†åŒºæˆ–åˆ†åº“åˆ†è¡¨ä»¥é¿å…å•è¡¨è†¨èƒ€ã€‚

## å¤‡ä»½ã€å½’æ¡£ä¸æ¢å¤
- æ•°æ®åº“ï¼šæ¯æ—¥å¢é‡ + æ¯å‘¨å…¨å¤‡ï¼›ä¿ç•™å‘¨æœŸæ ¹æ®åˆè§„ï¼ˆå»ºè®® 30â€“90 å¤©çƒ­å¤‡åå½’æ¡£ï¼‰ã€‚
- æ–‡ä»¶ï¼šå¯¹è±¡å­˜å‚¨å¼€å¯ç‰ˆæœ¬ä¸å¤šå‰¯æœ¬ï¼›å®šæœŸåŒæ­¥åˆ°å†·å­˜å‚¨ï¼ˆGlacier ç±»ï¼‰ã€‚
- æ¢å¤æ¼”ç»ƒï¼šå­£åº¦æ¢å¤æµ‹è¯•ï¼ŒéªŒè¯å¤‡ä»½å®Œæ•´æ€§ä¸æ¢å¤æ—¶é—´ç›®æ ‡ï¼ˆRTO/RPOï¼‰ã€‚