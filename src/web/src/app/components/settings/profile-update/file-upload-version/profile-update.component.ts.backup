import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { RequestService } from '../../../core/services/request.service';
import { AuthService } from '../../../core/services/auth.service';
import { User } from '../../../core/models';
import { v4 as uuidv4 } from 'uuid';

@Component({
    selector: 'app-profile-update',
    standalone: true,
    imports: [CommonModule, FormsModule],
    templateUrl: './profile-update.component.html.backup',
    styleUrls: ['./profile-update.component.css.backup']
})
export class ProfileUpdateComponent implements OnInit {
    username: string = '';
    email: string = '';
    password: string = '';
    avatar: string = '';
    avatarToUploadUrl: string | null = null;

    isLoading = false;
    errorMessage: string | null = null;
    successMessage: string | null = null;

    currentUser: User | null = null;
    selectedFile: File | null = null;
    uploadProgress: number | null = null;

    constructor(
        private requestService: RequestService,
        private authService: AuthService,
        private router: Router,
    ) { }

    ngOnInit() {
        const user = this.authService.currentUserValue;
        if (user) {
            this.currentUser = user;
            this.username = user.username;
            this.email = user.email;
            this.avatar = user.avatar;
        }
    }

    onBack(): void {
        this.router.navigate(['/settings']);
    }

    onFileSelected(event: any): void {
        const file: File = event.target.files[0];
        if (file) {
            this.selectedFile = file;

            // 预览选中的图片
            const reader = new FileReader();
            reader.onload = (e: any) => {
                this.avatarToUploadUrl = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

  fileToString(file: File): Promise<string> {
    return new Promise<string>((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = () => {
        // 获取文件的 ArrayBuffer
        const arrayBuffer = reader.result as ArrayBuffer;
        const uint8Array = new Uint8Array(arrayBuffer);

        // 将每个字节转换为字符并组成字符串
        let result = '';
        for (let i = 0; i < uint8Array.length; i++) {
          result += String.fromCharCode(uint8Array[i]);
        }

        resolve(result);
      };

      reader.onerror = () => {
        reject(new Error('读取文件时发生错误'));
      };

      reader.readAsArrayBuffer(file);
    });
  }

    convertImageToBase64(image: File): Promise<string> {
      return new Promise<string>((resolve, reject) => {
        const reader = new FileReader();

        reader.onloadend = () => {
          const base64String = reader.result as string;
          resolve(base64String);
        };

        reader.onerror = reject;

        reader.readAsDataURL(image);
      });
    }

    onSubmit(): void {
        this.errorMessage = null;
        this.successMessage = null;
        this.isLoading = true;
        this.uploadProgress = 5;

        if (this.selectedFile){
          const extensionIndex = this.selectedFile.name.lastIndexOf('.');
          const fileExtension = this.selectedFile.name.substring(extensionIndex);
          const fileName = this.selectedFile.name.substring(0, extensionIndex) + uuidv4() + fileExtension;
          const fileRelativePath = 'custom_avatar/' + fileName;
          this.uploadProgress = 20;

          if (!this.username.trim()) {
            this.isLoading = false;
            this.errorMessage = '用户名不能为空';
            this.uploadProgress = null;
            return;
          }

          if (!this.email.trim()) {
            this.isLoading = false;
            this.errorMessage = '邮箱不能为空';
            this.uploadProgress = null;
            return;
          }

          const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
          if (!emailRegex.test(this.email)) {
            this.isLoading = false;
            this.errorMessage = '请输入有效的邮箱地址';
            this.uploadProgress = null;
            return;
          }

          // 使用异步方式处理文件转字符串
          this.convertImageToBase64(this.selectedFile)
            .then((dataStream: string) => {
              this.uploadProgress = 40;
              this.requestService.uploadFile(
                {
                  filePath: '/home/cloudchat/client/html/' + fileRelativePath,
                  dataStream: dataStream,
                },
                (filePath) => {
                  this.uploadProgress = 60;
                  if (filePath && filePath.endsWith(fileRelativePath)) {
                    this.uploadProgress = 80;
                    this.avatar = fileRelativePath;
                    this.submitProfileUpdate();
                  }
                  else {
                    this.isLoading = false;
                    this.uploadProgress = null;
                    this.errorMessage = '上传文件失败，请稍后重试';
                  }
                },
                (error) => {
                  this.isLoading = false;
                  this.uploadProgress = null;
                  this.errorMessage = error || '上传文件失败，请稍后重试';
                }
              );
            })
            .catch((error) => {
              this.isLoading = false;
              this.uploadProgress = null;
              this.errorMessage = error.message || '读取文件时发生错误';
            });
        } else {
          // 没有选择文件时直接提交更新
          this.submitProfileUpdate();
        }
    }

    private submitProfileUpdate(): void {
      this.uploadProgress = 80;

      if (this.currentUser) {
        const isUsernameChanged = this.username !== this.currentUser.username;
        const isEmailChanged = this.email !== this.currentUser.email;
        const isAvatarChanged = this.avatar !== this.currentUser.avatar;

        if (!isUsernameChanged && !isEmailChanged && !isAvatarChanged) {
          this.isLoading = false;
          this.errorMessage = '没有更改任何信息';
          this.uploadProgress = null;
          return;
        }

        const payload = {
          userId: this.currentUser.userId,
          username: this.username,
          password: this.password,
          email: this.email,
          avatar: this.avatar
        };

        this.requestService.updateProfile(
          payload,
          () => {
            this.isLoading = false;
            this.uploadProgress = 100;
            this.successMessage = '个人信息更新成功';

            setTimeout(() => {
              this.uploadProgress = null;
            }, 100);
          },
          (error) => {
            this.isLoading = false;
            this.uploadProgress = null;
            this.errorMessage = error || '更新失败，请稍后重试';
          }
        );


        setTimeout(() => {
          if (!this.successMessage && !this.errorMessage){
            this.isLoading = false;
            this.uploadProgress = null;
            this.errorMessage = '更新请求超时，请重试';
          }
        }, 5000);
      }
      else {
        this.isLoading = false;
        this.uploadProgress = null;
        this.errorMessage = '登录过期';
      }
    }
}
