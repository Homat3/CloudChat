<div class="add-contact-overlay" (click)="closeOverlay($event)">
  <div class="add-contact-modal">
    <h2>æ·»åŠ è”ç³»äºº</h2>

    <!-- æœç´¢ä¸æ·»åŠ è”ç³»äººéƒ¨åˆ† -->
    <div class="section">
      <h3>æœç´¢ç”¨æˆ·</h3>
      <div class="search-options">
        <div class="search-option" [class.active]="searchType === 'id'">
          <input
            type="radio"
            id="searchById"
            name="searchType"
            value="id"
            [(ngModel)]="searchType"
            (change)="onSearchTypeChange()">
          <label for="searchById">é€šè¿‡IDæœç´¢</label>
        </div>
        <div class="search-option" [class.active]="searchType === 'username'">
          <input
            type="radio"
            id="searchByUsername"
            name="searchType"
            value="username"
            [(ngModel)]="searchType"
            (change)="onSearchTypeChange()">
          <label for="searchByUsername">é€šè¿‡ç”¨æˆ·åæœç´¢</label>
        </div>
      </div>

      <div class="search-input-container">
        @if (searchType === 'id'){
          <input
            type="number"
            [(ngModel)]="searchId"
            placeholder="ğŸ”è¾“å…¥ç”¨æˆ·ID"
            class="search-input">
        } @else if (searchType === 'username'){
          <input
            type="text"
            [(ngModel)]="searchUsername"
            placeholder="ğŸ”è¾“å…¥ç”¨æˆ·å"
            class="search-input">
        } @else {
          <label> Error </label>
        }

        <button (click)="searchContact()" class="search-button">æœç´¢</button>
      </div>

      @if (searchResult && searchResult.length > 0){
        <div class="search-result">
          <div class="result-header">
            <h4>æœç´¢ç»“æœ</h4>
            <select [(ngModel)]="selectedContact" class="contact-select">
              <option [ngValue]="null">è¯·é€‰æ‹©è¦æ·»åŠ çš„è”ç³»äºº</option>
              @for (contact of searchResult; track contact.contactId){
                <option [ngValue]="contact">
                  <div class="setting-item">
                    <div class="setting-info">
                      @if (contact.avatar){
                        <div class="w-48 h-48 rounded-full bg-gradient-to-br items-center justify-center text-white text-3xl font-bold">
                          <img src="{{contact.avatar}}" alt="{{ contact.username.charAt(0) || '?' }}" style="border-radius: 50%; width: 20%; height: 20%">
                        </div>
                      } @else {
                        <label>{{ contact.username.charAt(0) || '?' }}</label>
                      }
                    </div>
                  </div>
                  {{ contact.username }} <br> (ID: {{ contact.contactId }})
                </option>
              }
            </select>
            <button
              (click)="addContact()"
              [disabled]="!selectedContact"
              class="add-button">
              æ·»åŠ è”ç³»äºº
            </button>
          </div>
        </div>
      }

      @if (searchResult && searchResult.length === 0){
        <div class="no-results">
          æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·
        </div>
      }

      @if (searchError){
        <div class="error-message">
          {{ searchError }}
        </div>
      }
    </div>

    <!-- å¥½å‹ç”³è¯·åˆ—è¡¨éƒ¨åˆ† -->
    <div class="section">
      <h3>å¥½å‹ç”³è¯·</h3>
      <div class="friend-requests-container">
        @if (friendRequests && friendRequests.size > 0) {
          @for (request of friendRequests; track request[0]) {
            <div class="friend-request-item">
              <div class="request-info">
                <div class="avatar-container">
                  @if (isCurrentUserRequester(request[1])) {
                    @if (request[1].targetAvatar) {
                      <img [src]="request[1].targetAvatar" class="avatar" alt="{{ request[1].targetUsername }}">
                    } @else {
                      <div class="avatar">{{ request[1].targetUsername.charAt(0) }}</div>
                    }
                  } @else {
                    @if (request[1].requesterAvatar) {
                      <img [src]="request[1].requesterAvatar" class="avatar" alt="{{ request[1].requesterUsername }}">
                    } @else {
                      <div class="avatar">{{ request[1].requesterUsername.charAt(0) }}</div>
                    }
                  }
                </div>
                <div class="request-details">
                  @if (isCurrentUserRequester(request[1])) {
                    <div class="request-text">
                      æ‚¨å‘ <strong>{{ request[1].targetUsername }}</strong> å‘é€äº†å¥½å‹ç”³è¯·
                    </div>
                  } @else {
                    <div class="request-text">
                      <strong>{{ request[1].requesterUsername }}</strong> è¯·æ±‚æ·»åŠ æ‚¨ä¸ºå¥½å‹
                    </div>
                  }
                  <div class="request-status">
                    @switch (request[1].status) {
                      @case ('pending') {
                        @if (isCurrentUserRequester(request[1])) {
                          <span class="status pending">å¾…éªŒè¯</span>
                        } @else {
                          <span class="status pending">å¾…å¤„ç†</span>
                        }
                      }
                      @case ('accepted') {
                        <span class="status accepted">å·²åŒæ„</span>
                      }
                      @case ('refused') {
                        <span class="status refused">å·²æ‹’ç»</span>
                      }
                    }
                  </div>
                </div>
              </div>

              @if (!isCurrentUserRequester(request[1]) && request[1].status === 'pending') {
                <div class="request-actions">
                  <button class="btn btn-success" (click)="acceptRequest(request[1])">åŒæ„</button>
                  <button class="btn btn-danger" (click)="refuseRequest(request[1])">æ‹’ç»</button>
                </div>
              } @else if (isCurrentUserRequester(request[1])) {
                <div class="request-actions readonly">
                  @switch (request[1].status) {
                    @case ('pending') {
                      <span class="status pending">å¾…éªŒè¯</span>
                    }
                    @case ('accepted') {
                      <span class="status accepted">å·²åŒæ„</span>
                    }
                    @case ('refused') {
                      <span class="status refused">å·²æ‹’ç»</span>
                    }
                  }
                </div>
              }
            </div>
          }
        } @else {
          <div class="no-requests">
            æš‚æ— å¥½å‹ç”³è¯·
          </div>
        }
      </div>
    </div>

    <div class="modal-actions">
      <button (click)="close()" class="cancel-button">å…³é—­</button>
    </div>
  </div>
</div>
