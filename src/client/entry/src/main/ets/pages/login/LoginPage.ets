
import { common } from '@kit.AbilityKit';
import { promptAction, router } from '@kit.ArkUI';
import { Page } from '../../entryability/manager/window-stage-manager/WindowStageManager';

@Entry
@Component
struct LoginPage {
  @State username: string = '';
  @State password: string = '';
  @State errorMessage: string = '';
  @State isLoading:boolean = false;
  @State rememberMe:boolean=false;
  private context:common.UIAbilityContext | null = null;

  //å°è¯•è¯»å–ä¿å­˜çš„ç”¨æˆ·å
  aboutToAppear(): void {
      this.context = getContext(this) as common.UIAbilityContext;
    // ç›‘å¬ç™»å½•æˆåŠŸäº‹ä»¶
    this.context?.eventHub.on('loginSuccess', () => {
      router.replaceUrl({ url: 'pages/Home' });
    });

    // ç›‘å¬ç™»å½•å¤±è´¥äº‹ä»¶
    this.context?.eventHub.on('loginFailed', (err: Error) => {
      this.isLoading = false;
      this.errorMessage = err.message || 'ç™»å½•å¤±è´¥';
    });
  }

  aboutToDisappear(): void {
    // ç§»é™¤äº‹ä»¶ç›‘å¬
    this.context?.eventHub.off('loginSuccess');
    this.context?.eventHub.off('loginFailed');
  }

  build() {
    Column({space : 8}) {
      Column() {
        //Logo
        Text('ğŸ’¬')
          .fontSize(64)
          .margin({ bottom: 8 })
        Column() {
          Text('CloudChat')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#409EFF')

          Text('æ™ºèƒ½èŠå¤©')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#409EFF')
        }
      }
      .margin({ top: 40, bottom: 30 })
      .alignItems(HorizontalAlign.Center)

      //ç™»å½•è¡¨å•
      Column({ space: 16 }) {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        TextInput({
          text: this.username,
          placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å'
        })
          .id('usernameInput')
          .type(InputType.Normal)
          .height(50)
          .width('80%')
          .padding(12)
          .backgroundColor('Color.Transparent')
          .border({
            width: 1,
            color: '#DCDFE6'
          })
          .alignRules({
            top: { anchor: 'welcomeTitle', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .margin({ top: 30 })
          .onChange((value: string) => {
            this.username = value;
            this.errorMessage = '';
          })

        // å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.password,
          placeholder: 'è¯·è¾“å…¥å¯†ç '
        })
          .id('passwordInput')
          .type(InputType.Password)
          .height(50)
          .width('80%')
          .backgroundColor('')
          .border({
            width: 1,
            color: '#DCDFE6'
          })
          .alignRules({
            top: { anchor: 'usernameInput', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .onChange((value: string) => {
            this.password = value;
            this.errorMessage = '';
          })

        Row() {
          //è®°ä½æˆ‘
          Row({ space: 0 }) {
            Checkbox()
              .select(this.rememberMe)
              .onChange((checked: boolean) => {
                this.rememberMe = checked;
              })
              .size({ width: 18, height: 18 })

            Text('è®°ä½æˆ‘')
              .fontSize(14)
              .fontColor('#606266')
              .margin({ left: 4 })
          }
          .margin({left:20})
          .onClick(() => {
            this.rememberMe = !this.rememberMe;
          })

          Blank()

          //å¿˜è®°å¯†ç 
          Text('å¿˜è®°å¯†ç ï¼Ÿ')
            .fontSize(14)
            .fontColor('#409EFF')
            .margin({right:4})
            .onClick(() => {
              promptAction.showToast({
                message: 'åŠŸèƒ½å¼€å‘ä¸­...',
                duration: 2000
              });
            })
        }
        .width('100%')
        .padding({ left: 4, right: 4 })


        //ç™»å½•æŒ‰é’®
        Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
          .id('loginButton')
          .width('80%')
          .height(50)
          .backgroundColor(this.canLogin() && !this.isLoading ? '#409EFF' : '#c0c4cc')
          .alignRules({
            top: { anchor: 'passwordInput', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .margin({ top: 20 })
          .fontColor('#ffffff')
          .enabled(this.canLogin() && !this.isLoading)//ç™»å½•æ—¶ç¦ç”¨
          .onClick(() => {
            this.handleLogin();
          })

        //æ³¨å†ŒæŒ‰é’®
        Button('æ³¨å†Œè´¦å·')
          .id('registerButton')
          .width('80%')
          .height(50)
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#409EFF')
          .borderRadius(8)
          .border({
            width: 1,
            color: '#409EFF'
          })
          .margin({ top: 10 })
          .onClick(() => {
            router.pushUrl({
              url: Page.REGISTER_PAGE
            }).catch((error: Error) => {
              console.error('Route failed:', error);
              promptAction.showToast({
                message: 'æ— æ³•æ‰“å¼€æ³¨å†Œé¡µé¢',
                duration: 2000
              });
            })
          })
        //é”™è¯¯æç¤º
        if (this.errorMessage) {
          Text(this.errorMessage)
            .id('errorText')
            .fontColor(Color.Red)
            .fontSize(14)
            .alignRules({
              top: { anchor: 'loginButton', align: VerticalAlign.Bottom },
              middle: { anchor: '__container__', align: HorizontalAlign.Center }
            })
            .margin({ top: 10 })
            .padding(8)
        }

      }

    }
  }



  private handleLogin() {
    if (!this.canLogin()) {
      this.errorMessage = 'ç”¨æˆ·åéœ€5ä½ä»¥ä¸Šå­—æ¯æ•°å­—ï¼Œå¯†ç éœ€8ä½ä»¥ä¸Š';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    // const context = this.context as common.UIAbilityContext;
    // try {
    //   context.eventHub.emit(Event.LOGIN, {
    //     username: this.username,
    //     password: this.password
    //   });
    // } catch (error) {
    //   this.isLoading = false;
    //   this.errorMessage = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    //   console.error('Login error:', error);
    // }
  }
  private canLogin(): boolean {
    const usernameValid = /^[a-zA-Z0-9_]{5,20}$/.test(this.username);
    const passwordValid = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/.test(this.password);

    if (!usernameValid) {
      this.errorMessage = 'ç”¨æˆ·åéœ€5-20ä½å­—æ¯æ•°å­—æˆ–ä¸‹åˆ’çº¿';
      return false;
    }

    if (!passwordValid) {
      this.errorMessage = 'å¯†ç éœ€è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—';
      return false;
    }

    return true;
  }
}


