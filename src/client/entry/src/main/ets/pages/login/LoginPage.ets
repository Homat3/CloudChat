import { common } from '@kit.AbilityKit';
import { HttpClientMessageType, LoginPayload, LogoutPayload } from '../../core/protocol/http/client.http.protocol';
import { HttpService } from '../../core/service/network/http/server.http';
import { loadStringResource } from '../../core/util/load-resource';
import { CallBackManager, Event } from '../../entryability/manager/call-back-manager/CallBackManager';
import { Page } from '../../entryability/manager/window-stage-manager/WindowStageManager';
import { http } from '@kit.NetworkKit';
import { UserManager } from './user-manager';
import { LoginResult, LoginService } from './login-service';
import { LoginSuccessPayload } from '../../core/protocol/http/service.http.protocol';

//import { AppStorage } from '@kit.ArkTS'; // æ·»åŠ AppStorageå¯¼å…¥

//å‘é€çš„ç™»å½•æ¶ˆæ¯
interface LoginInfo {
  type: HttpClientMessageType,
  payload: LoginPayload
}

// å®šä¹‰ç”¨æˆ·æ•°æ®ç±»å‹
interface UserData {
  userId: number;
  username: string;
  token: string;
  avatar: string;
}

// å®šä¹‰æœåŠ¡å™¨å“åº”ç±»å‹
interface GeneratedTypeLiteralInterface_1 {
  userId?: number;
  username?: string;
  token?: string;
  avatar?: string;
  error?: string;
}

interface LoginResponse {
  type: string;
  payload?: GeneratedTypeLiteralInterface_1
}

@Entry
@Component
struct LoginPage {
  // çŠ¶æ€
  @State username: string = '';
  @State password: string = '';
  @State errorMessage: string = '';
  @State isLoading: boolean = false;
  @State rememberMe: boolean = false;
  // ä¸Šä¸‹æ–‡
  private uiContext: UIContext = this.getUIContext();
  private uiAbilityContext: common.UIAbilityContext = this.uiContext.getHostContext() as common.UIAbilityContext;
  // ç®¡ç†å™¨
  private callBackManager: CallBackManager = new CallBackManager(this.uiAbilityContext.eventHub);   // call back ç®¡ç†å™¨
  private loginService: LoginService = new LoginService();

  //å°è¯•è¯»å–ä¿å­˜çš„ç”¨æˆ·å
  aboutToAppear(): void {
    try {
        //è®°ä½çš„ç”¨æˆ·å
        const rememberedUsername = UserManager.getRememberedUsername();
        if(rememberedUsername){
          this.username = rememberedUsername;
          this.rememberMe = true;
        }

       // ç›‘å¬ç™»å½•æˆåŠŸäº‹ä»¶
        this.callBackManager.addEventSubscription(Event.LOGIN_SUCCESS, () => {
        this.uiContext.getRouter().replaceUrl({ url: 'pages/Home' }).catch((e: Error) => {
          console.error(e.message);
        });
      });
      // ç›‘å¬ç™»å½•å¤±è´¥äº‹ä»¶
      this.callBackManager.addEventSubscription(Event.LOGIN_FAILED, (err: Error) => {
        this.isLoading = false;
        this.errorMessage = err.message || loadStringResource(this.uiAbilityContext, $r("app.string.error_login_LoginFailed"));
      });


      this.checkLocalTokenAndAutoLogin();

    } catch (error) {
      console.error(error);
    }
  }

  aboutToDisappear(): void {
    // ç§»é™¤äº‹ä»¶ç›‘å¬
    try {
      this.callBackManager.removeEventSubscription(Event.LOGIN_SUCCESS);
      this.callBackManager.removeEventSubscription(Event.LOGIN_FAILED);
    } catch (error) {
      console.error(error);
    }
  }

  build() {
    Column({ space: 8 }) {
      Column() {
        //Logo
        Text('ğŸ’¬').fontSize(64).margin({ bottom: 8 })
        Column() {
          Text($r("app.string.text_login_Title")).fontSize(28).fontWeight(FontWeight.Bold).fontColor($r("app.color.login_title_font"))
          Text($r("app.string.text_login_Subtitle")).fontSize(14).fontWeight(FontWeight.Bold).fontColor($r("app.color.login_title_font"))
        }
      }
      .margin({ top: 40, bottom: 30 })
      .alignItems(HorizontalAlign.Center)

      //ç™»å½•è¡¨å•
      Column({ space: 16 }) {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        TextInput({
          text: this.username,
          placeholder: $r("app.string.text_login_UsernamePlaceholder")
        })
          .id('usernameInput')
          .type(InputType.Normal)
          .height(50)
          .width('80%')
          .padding(12)
          .backgroundColor(Color.Transparent)
          .border({
            width: 1,
            color: $r("app.color.login_textInput_all_border")
          })
          .alignRules({
            top: { anchor: 'welcomeTitle', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .margin({ top: 30 })
          .onChange((value: string) => {
            this.username = value;
            this.errorMessage = '';
          })

        // å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.password,
          placeholder: $r("app.string.text_login_PasswordPlaceholder")
        })
          .id('passwordInput')
          .type(InputType.Password)
          .height(50)
          .width('80%')
          .backgroundColor('')
          .border({
            width: 1,
            color: $r("app.color.login_textInput_all_border")
          })
          .alignRules({
            top: { anchor: 'passwordInput', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .onChange((value: string) => {
            this.password = value;
            this.errorMessage = '';
          })

        Row() {
          //è®°ä½æˆ‘
          Row({ space: 0 }) {
            Checkbox().select(this.rememberMe).onChange((checked: boolean) => {
              this.rememberMe = checked;
            }).size({ width: 18, height: 18 })

            Text($r("app.string.text_login_RememberMe")).margin({ left: 4 }).fontSize(14).fontColor($r("app.color.login_text_rememberMe_font"))
          }
          .margin({ left: 20 })
          .onClick(() => {
            this.rememberMe = !this.rememberMe;
          })

          Blank()

          //å¿˜è®°å¯†ç 
          Text($r("app.string.text_login_ForgotPassword")).margin({ right: 4 }).fontSize(14).fontColor($r("app.color.login_text_forgetPassword_font"))
            .onClick(() => {
              try {
                this.uiContext.getPromptAction().showToast({
                  message: $r("app.string.text_login_MoreAbilities"),
                  duration: 2000
                })
              } catch (error) {
                console.error(error);
              }
            })
        }.width('100%').padding({ left: 4, right: 4 })


        //ç™»å½•æŒ‰é’®
        Button(this.isLoading ? $r("app.string.text_login_LoggingIn") : $r("app.string.text_login_Login"))
          .id('loginButton')
          .width('80%')
          .height(50)
          .backgroundColor($r(this.canLogin() && !this.isLoading ?
            "app.color.login_button_login_background_enabled" : "app.color.login_button_login_background_disabled")
          )
          .alignRules({
            top: { anchor: 'passwordInput', align: VerticalAlign.Bottom },
            middle: { anchor: '__container__', align: HorizontalAlign.Center }
          })
          .margin({ top: 20 })
          .fontColor($r("app.color.login_button_login_font"))
          .enabled(this.canLogin() && !this.isLoading)  //ç™»å½•æ—¶ç¦ç”¨
          .onClick(() => {
            this.handleLogin();
          })

        //æ³¨å†ŒæŒ‰é’®
        Button('æ³¨å†Œè´¦å·')
          .id('registerButton')
          .width('80%')
          .height(50)
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor($r("app.color.login_button_login_background_enabled"))
          .borderRadius(8)
          .border({
            width: 1,
            color: $r("app.color.login_button_login_border")
          })
          .margin({ top: 10 })
          .onClick(() => {
            this.uiContext.getRouter().pushUrl({
              url: Page.REGISTER_PAGE
            }).catch((error: Error) => {
              console.error('Route failed:', error);
              try {
                this.uiContext.getPromptAction().showToast({
                  message: 'æ— æ³•æ‰“å¼€æ³¨å†Œé¡µé¢',
                  duration: 2000
                });
              } catch (error) {
                console.error("Unknown error")
              }
            })
          })
        //é”™è¯¯æç¤º
        if (this.errorMessage) {
          Text(this.errorMessage)
            .id('errorText')
            .fontColor(Color.Red)
            .fontSize(14)
            .alignRules({
              top: { anchor: 'loginButton', align: VerticalAlign.Bottom },
              middle: { anchor: '__container__', align: HorizontalAlign.Center }
            })
            .margin({ top: 10 })
            .padding(8)
        }
      }
    }
  }


  //æ£€æŸ¥æœ¬åœ°ä»¤ç‰Œå¹¶å°è¯•è‡ªåŠ¨ç™»å½•
  private checkLocalTokenAndAutoLogin():void{
    const localTokenInfo = UserManager.getLocalTokenInfo();

    if(localTokenInfo){
      console.log('Local Token is found,login...');
      this.isLoading = true;

      this.username = localTokenInfo.username;
      //å»¶è¿Ÿå‘é€è¯·æ±‚
      setTimeout(()=>{
        this.performTokenLogin(localTokenInfo.username,localTokenInfo.token);
      },200);
    }
  }

  //æ‰§è¡Œä»¤ç‰Œç™»å½•
  private performTokenLogin(username: string,token: string):void{
    this.loginService.tokenLogin(username,token)
      .then((result)=>{
        this.isLoading = false;

        if(result.success && result.userData){
          UserManager.saveUserData(result.userData,this.rememberMe);
          this.uiAbilityContext.eventHub.emit(Event.LOGIN_SUCCESS);
        }else{
          console.log('ä»¤ç‰Œç™»å½•å¤±è´¥:',result.error);
          this.uiAbilityContext.eventHub.emit(Event.LOGIN_FAILED,new Error(result.error
          ||'è‡ªåŠ¨ç™»å½•å¤±è´¥..'));
        }
      })
      .catch((error:Error)=>{
        this.isLoading = false;
        console.error('ä»¤ç‰Œç™»å½•å¤±è´¥',error);
        this.uiAbilityContext.eventHub.emit(Event.LOGIN_FAILED,error);
      });
  }

  //æ£€æµ‹ç™»å½•éªŒè¯
  private handleLogin() {
    if (!this.canLogin()) {
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    // ä½¿ç”¨LoginServiceè¿›è¡Œç™»å½•
    this.loginService.passwordLogin(this.username, this.password)
      .then((result: LoginResult) => {
        this.isLoading = false;

        if (result.success && result.userData) {
          // ç™»å½•æˆåŠŸï¼Œä¿å­˜ç”¨æˆ·æ•°æ®
          this.saveUserData(result.userData);

          // è§¦å‘ç™»å½•æˆåŠŸäº‹ä»¶
          // ä½¿ç”¨eventHubè€Œä¸æ˜¯callBackManager.emit
          this.uiAbilityContext.eventHub.emit(Event.LOGIN_SUCCESS);
        } else {
          // ç™»å½•å¤±è´¥
          this.errorMessage = result.error || 'ç™»å½•å¤±è´¥';
          this.uiAbilityContext.eventHub.emit(Event.LOGIN_FAILED, new Error(this.errorMessage));
        }
      })
      .catch((error:Error) => {
        this.isLoading = false;
        this.errorMessage = error.message || 'ç™»å½•å¼‚å¸¸';
        this.uiAbilityContext.eventHub.emit(Event.LOGIN_FAILED, new Error(this.errorMessage));
      });
  }

  ///ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  private saveUserData(userData: LoginSuccessPayload): void {
    UserManager.saveUserData(userData, this.rememberMe);
  }

  //æœ¬åœ°éªŒè¯è¡¨å•ä¿¡æ¯
  private canLogin(): boolean {
    const usernameValid = /^[a-zA-Z0-9_]{5,20}$/.test(this.username);
    const passwordValid = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/.test(this.password);

    if (!usernameValid) {
      this.errorMessage = loadStringResource(this.uiAbilityContext, $r("app.string.error_login_UsernameInputError"));
      return false;
    }

    if (!passwordValid) {
      this.errorMessage = loadStringResource(this.uiAbilityContext, $r("app.string.error_login_PasswordInputError"));
      return false;
    }

    this.errorMessage = '';
    return true;
  }
}