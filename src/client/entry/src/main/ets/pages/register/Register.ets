import { User } from '../../core/models/models'
import { promptAction, router } from '@kit.ArkUI';
import { Page } from '../../entryability/manager/window-stage-manager/WindowStageManager';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Entry
@Component
struct Register {
  @State Title: string = 'æ³¨å†Œç•Œé¢'
  @State userName: string = ''
  @State email: string = ''
  @State passWord: string = ''
  @State passWord_check: string = ''
  @State errorMessage: string = ''
  @State isLoading: boolean = false

  // æ·»åŠ å„ä¸ªå­—æ®µçš„ç‹¬ç«‹é”™è¯¯çŠ¶æ€ï¼Œç”¨äºå®æ—¶éªŒè¯
  @State userNameError: string = ''
  @State emailError: string = ''
  @State passwordError: string = ''
  @State confirmPasswordError: string = ''

  build() {
    Column({ space: 8 }) {
      // Logo/æ ‡è¯­é¡¶éƒ¨åŒºåŸŸ
      Column() {
        Text('ğŸ’¬')
          .fontSize(64)
          .margin({ bottom: 8 })
        Column() {
          Text('CloudChat')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#409EFF')

          Text('æ³¨å†Œç•Œé¢')
            .fontSize(14)
            .fontColor('#909399')
        }
      }
      .margin({ top: 40, bottom: 30 })
      .alignItems(HorizontalAlign.Center)

      // æ³¨å†Œè¡¨å•åŒºåŸŸ
      Column({ space: 16 }) {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        TextInput({
          text: this.userName,
          placeholder: 'è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ5-20ä½å­—æ¯æ•°å­—ï¼‰'
        })
          .type(InputType.Normal)
          .height(50)
          .width('100%')
          .padding(12)
          .backgroundColor('Color.Transparent')
          .border({
            width: this.userNameError ? 2 : 1,
            color: this.userNameError ? Color.Red : '#DCDFE6'
          })
          .onChange((value: string) => {
            this.userName = value;
            this.userNameError = this.validateUserName(value);
            this.updateErrorMessage();
          })

        // ç”¨æˆ·åé”™è¯¯æç¤º
        if (this.userNameError) {
          Text(this.userNameError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // é‚®ç®±è¾“å…¥æ¡†
        TextInput({
          text: this.email,
          placeholder: 'è¯·è¾“å…¥é‚®ç®±å·'
        })
          .type(InputType.Normal)
          .height(50)
          .width('100%')
          .backgroundColor('Color.Transparent')
          .border({
            width: this.emailError ? 2 : 1,
            color: this.emailError ? Color.Red : '#DCDFE6'
          })
          .onChange((value: string) => {
            this.email = value;
            this.emailError = this.validateEmail(value);
            this.updateErrorMessage();
          })

        // é‚®ç®±é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.emailError) {
          Text(this.emailError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.passWord,
          placeholder: 'è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å­—æ¯æ•°å­—ï¼‰'
        })
          .type(InputType.Password)
          .height(50)
          .width('100%')
          .backgroundColor('Color.Transparent')
          .border({
            width: this.passwordError ? 2 : 1,
            color: this.passwordError ? Color.Red : '#DCDFE6'
          })
          .onChange((value: string) => {
            this.passWord = value;
            this.passwordError = this.validatePassword(value);
            // å¦‚æœç¡®è®¤å¯†ç å·²è¾“å…¥ï¼Œéœ€è¦é‡æ–°éªŒè¯ç¡®è®¤å¯†ç 
            if (this.passWord_check) {
              this.confirmPasswordError = this.validateConfirmPassword(value, this.passWord_check);
            }
            this.updateErrorMessage();
          })

        // å¯†ç é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.passwordError) {
          Text(this.passwordError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // ç¡®è®¤å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.passWord_check,
          placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç '
        })
          .type(InputType.Password)
          .height(50)
          .width('100%')
          .backgroundColor('Color.Transparent')
          .border({
            width: this.confirmPasswordError ? 2 : 1,
            color: this.confirmPasswordError ? Color.Red : '#DCDFE6'
          })
          .onChange((value: string) => {
            this.passWord_check = value;
            this.confirmPasswordError = this.validateConfirmPassword(this.passWord, value);
            this.updateErrorMessage();
          })

        // ç¡®è®¤å¯†ç é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.confirmPasswordError) {
          Text(this.confirmPasswordError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // æ³¨å†ŒæŒ‰é’®
        //TODO:å‘é€æ³¨å†Œä¿¡æ¯
        Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ')
          .width('100%')
          .height(48)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.canRegister() ? '#409EFF' : '#A0CFFF')
          .opacity(this.canRegister() ? 1 : 0.6)
          .enabled(this.canRegister() && !this.isLoading)
          .onClick(() => {
            this.handleRegister();
          })

        // è¿”å›ç™»å½•æŒ‰é’®
        Button('è¿”å›ç™»å½•')
          .width('100%')
          .height(48)
          .fontSize(16)
          .fontColor('#409EFF')
          .backgroundColor(Color.Transparent)
          .borderRadius(8)
          .border({
            width: 1,
            color: '#409EFF'
          })
          .margin({ top: 10 })
          .onClick(() => {
            router.pushUrl({
              url: Page.LOGIN_PAGE
            }).catch(() => {
              router.pushUrl({
                url: 'pages/login/LoginPage'
              });
            });
          })

        // ç³»ç»Ÿé”™è¯¯æç¤º
        if (this.errorMessage) {
          Row({ space: 8 }) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(Color.Red)
              .lineHeight(20)
          }
          .width('100%')
          .padding({ left: 8, right: 8, top: 8, bottom: 8 })
          .backgroundColor('#FFEBEE')
          .borderRadius(8)
        }

        // ç‰ˆæœ¬ä¿¡æ¯
        Text('CloudChat v2.0.0 Â· é¸¿è’™ç‰ˆ')
          .fontSize(12)
          .fontColor('#909399')
          .margin({ top: 40 })
      }
      .width('85%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
    .justifyContent(FlexAlign.Start)
    .alignItems(HorizontalAlign.Center)
  }

  //å†…éƒ¨å®ç°

  // ç›´æ¥è·³è½¬ç‰ˆæœ¬
  private handleRegister() {
    console.log('å¼€å§‹æ³¨å†Œå¤„ç†');
    // 1. éªŒè¯è¡¨å•
    if (!this.validateAll()) {
      console.log('è¡¨å•éªŒè¯å¤±è´¥');
      return;
    }
    // 2. è®¾ç½®åŠ è½½çŠ¶æ€
    this.isLoading = true;
    this.errorMessage = '';
    console.log('è¡¨å•éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡ç›´æ¥è·³è½¬');

    // è¿™é‡Œå‡è®¾æ³¨å†Œæ€»æ˜¯æˆåŠŸï¼Œç›´æ¥è·³è½¬åˆ°è”ç³»äººé¡µé¢
    console.log('è·³è½¬åˆ°:', Page.CONTACT_LIST_PAGE);
    // å…ˆæ˜¾ç¤ºæˆåŠŸæç¤º
    promptAction.showToast({
      message: 'æ³¨å†ŒæˆåŠŸ',
      duration: 1500
    });
    // ç›´æ¥è·³è½¬
    router.pushUrl({
      url: Page.CONTACT_LIST_PAGE
    }).then(() => {
      console.log('è·³è½¬æˆåŠŸ');
      this.isLoading = false; // ç†è®ºä¸Šè·³è½¬æˆåŠŸåè¿™ä¸ªé¡µé¢å°±é”€æ¯äº†
    }).catch((err: Error) => {
      console.error('è·³è½¬å¤±è´¥:', err);
      this.isLoading = false;
      this.errorMessage = `è·³è½¬å¤±è´¥: ${err.message || 'é¡µé¢ä¸å­˜åœ¨'}`;
      // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯
      promptAction.showToast({
        message: `è·³è½¬å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}`,
        duration: 3000
      });
    });
  }

  // æ›´æ–°å…¨å±€é”™è¯¯ä¿¡æ¯
  private updateErrorMessage(): void {
    this.errorMessage = '';
  }

  // éªŒè¯æ‰€æœ‰å­—æ®µ
  private validateAll(): boolean {
    console.log('éªŒè¯æ‰€æœ‰å­—æ®µ');

    this.userNameError = this.validateUserName(this.userName);
    this.emailError = this.validateEmail(this.email);
    this.passwordError = this.validatePassword(this.passWord);
    this.confirmPasswordError = this.validateConfirmPassword(this.passWord, this.passWord_check);

    const hasError = !!(this.userNameError || this.emailError || this.passwordError || this.confirmPasswordError);

    if (hasError) {
      console.log('éªŒè¯å¤±è´¥ï¼Œå­˜åœ¨é”™è¯¯');
    } else {
      console.log('æ‰€æœ‰å­—æ®µéªŒè¯é€šè¿‡');
    }

    return !hasError;
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ³¨å†Œ
  private canRegister(): boolean {
    // åªæœ‰æ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œä¸”æ²¡æœ‰æ­£åœ¨åŠ è½½æ—¶æ‰èƒ½æ³¨å†Œ
    const canRegister = this.userName.trim().length > 0 &&
      this.email.trim().length > 0 &&
      this.passWord.length > 0 &&
      this.passWord_check.length > 0 &&
      !this.isLoading;

    console.log(`canRegisteræ£€æŸ¥: ${canRegister}`);
    return canRegister;
  }

  // å„ä¸ªå­—æ®µçš„éªŒè¯å‡½æ•°
  private validateUserName(username: string): string {
    if (!username.trim()) {
      return 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º';
    }
    const usernameRegex = /^[a-zA-Z0-9_]{5,20}$/;
    if (!usernameRegex.test(username)) {
      return 'ç”¨æˆ·åéœ€5-20ä½å­—æ¯æ•°å­—æˆ–ä¸‹åˆ’çº¿';
    }
    return '';
  }


  //å®æ—¶è¡¨å•å…ƒç´ æ£€éªŒ
  private validateEmail(email: string): string {
    if (!email.trim()) {
      return 'é‚®ç®±ä¸èƒ½ä¸ºç©º';
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
    }
    return '';
  }

  private validatePassword(password: string): string {
    if (!password) {
      return 'å¯†ç ä¸èƒ½ä¸ºç©º';
    }
    if (password.length < 8) {
      return 'å¯†ç è‡³å°‘éœ€è¦8ä½';
    }
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/;
    if (!passwordRegex.test(password)) {
      return 'å¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—';
    }
    return '';
  }

  private validateConfirmPassword(password: string, confirmPassword: string): string {
    if (!confirmPassword) {
      return 'è¯·ç¡®è®¤å¯†ç ';
    }
    if (password !== confirmPassword) {
      return 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
    }
    return '';
  }
}