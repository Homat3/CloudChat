import { User } from '../../core/models/models'
import { App, promptAction, router } from '@kit.ArkUI';
import { Page } from '../../entryability/manager/window-stage-manager/WindowStageManager';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { common } from '@kit.AbilityKit';
import { loadStringResource } from '../../core/util/load-resource';
import { RegisterResult, RegisterService } from './register-service';
import { UserManager } from './user-manager';
import { RegisterSuccessPayload } from '../../core/protocol/http/service.http.protocol';

@Entry
@Component
struct Register {
  // çŠ¶æ€å˜é‡
  @State Title: string = 'æ³¨å†Œç•Œé¢'
  @State userName: string = ''
  @State email: string = ''
  @State passWord: string = ''
  @State passWord_check: string = ''
  @State errorMessage: string = ''
  @State isLoading: boolean = false

  // æ·»åŠ å„ä¸ªå­—æ®µçš„ç‹¬ç«‹é”™è¯¯çŠ¶æ€ï¼Œç”¨äºå®æ—¶éªŒè¯
  @State userNameError: string = ''
  @State emailError: string = ''
  @State passwordError: string = ''
  @State confirmPasswordError: string = ''

  // ä¸Šä¸‹æ–‡
  private uiContext: UIContext = this.getUIContext();
  private uiAbilityContext: common.UIAbilityContext = this.uiContext.getHostContext() as common.UIAbilityContext;

  private registerService:RegisterService = new RegisterService();

  build() {
    Column({ space: 8 }) {
      // Logo/æ ‡è¯­é¡¶éƒ¨åŒºåŸŸ
      Column() {
        Text('ğŸ’¬')
          .fontSize(64)
          .margin({ bottom: 8 })
        Column() {
          Text($r("app.string.text_all_Title"))
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor($r("app.color.register_title_font"))

          Text($r("app.string.text_register_RegisterYourAccount"))
            .fontSize(14)
            .fontColor($r("app.color.register_text_registerYourAccount_font"))
        }
      }
      .margin({ top: 40, bottom: 30 })
      .alignItems(HorizontalAlign.Center)

      // æ³¨å†Œè¡¨å•åŒºåŸŸ
      Column({ space: 16 }) {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        TextInput({
          text: this.userName,
          placeholder: $r("app.string.text_register_UsernamePlaceholder")
        })
          .type(InputType.Normal)
          .height(50)
          .width('100%')
          .padding(12)
          .backgroundColor(Color.Transparent)
          .border({
            width: this.userNameError ? 2 : 1,
            color: this.userNameError ? Color.Red : $r("app.color.register_textInput_font_normal")
          })
          .onChange((value: string) => {
            this.userName = value;
            this.userNameError = this.validateUserName(value);
            this.updateErrorMessage();
          })

        // ç”¨æˆ·åé”™è¯¯æç¤º
        if (this.userNameError) {
          Text(this.userNameError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // é‚®ç®±è¾“å…¥æ¡†
        TextInput({
          text: this.email,
          placeholder: $r("app.string.text_register_EmailPlaceholder")
        })
          .type(InputType.Normal)
          .height(50)
          .width('100%')
          .backgroundColor(Color.Transparent)
          .border({
            width: this.emailError ? 2 : 1,
            color: this.emailError ? Color.Red : $r("app.color.register_textInput_font_normal")
          })
          .onChange((value: string) => {
            this.email = value;
            this.emailError = this.validateEmail(value);
            this.updateErrorMessage();
          })

        // é‚®ç®±é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.emailError) {
          Text(this.emailError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.passWord,
          placeholder: $r("app.string.text_register_PasswordPlaceholder")
        })
          .type(InputType.Password)
          .height(50)
          .width('100%')
          .backgroundColor(Color.Transparent)
          .border({
            width: this.passwordError ? 2 : 1,
            color: this.passwordError ? Color.Red : $r("app.color.register_textInput_font_normal")
          })
          .onChange((value: string) => {
            this.passWord = value;
            this.passwordError = this.validatePassword(value);
            // å¦‚æœç¡®è®¤å¯†ç å·²è¾“å…¥ï¼Œéœ€è¦é‡æ–°éªŒè¯ç¡®è®¤å¯†ç 
            if (this.passWord_check) {
              this.confirmPasswordError = this.validateConfirmPassword(value, this.passWord_check);
            }
            this.updateErrorMessage();
          })

        // å¯†ç é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.passwordError) {
          Text(this.passwordError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // ç¡®è®¤å¯†ç è¾“å…¥æ¡†
        TextInput({
          text: this.passWord_check,
          placeholder: $r("app.string.text_register_PasswordAgainPlaceholder")
        })
          .type(InputType.Password)
          .height(50)
          .width('100%')
          .backgroundColor(Color.Transparent)
          .border({
            width: this.confirmPasswordError ? 2 : 1,
            color: this.confirmPasswordError ? Color.Red : $r("app.color.register_textInput_font_normal")
          })
          .onChange((value: string) => {
            this.passWord_check = value;
            this.confirmPasswordError = this.validateConfirmPassword(this.passWord, value);
            this.updateErrorMessage();
          })

        // ç¡®è®¤å¯†ç é”™è¯¯æç¤ºï¼ˆå®æ—¶ï¼‰
        if (this.confirmPasswordError) {
          Text(this.confirmPasswordError)
            .fontColor(Color.Red)
            .fontSize(12)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 4 })
        }

        // æ³¨å†ŒæŒ‰é’®
        //TODO:å‘é€æ³¨å†Œä¿¡æ¯
        Button(this.isLoading ? $r("app.string.text_register_Registering") : $r("app.string.text_register_Register"))
          .width('100%')
          .height(48)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.canRegister() ? $r("app.color.login_button_login_background_enabled") : $r("app.color.login_button_login_background_disabled"))
          .opacity(this.canRegister() ? 1 : 0.6)
          .enabled(this.canRegister() && !this.isLoading)
          .onClick(() => {
            this.handleRegister();
          })

        // è¿”å›ç™»å½•æŒ‰é’®
        Button($r("app.string.text_register_BackToLogin"))
          .width('100%')
          .height(48)
          .fontSize(16)
          .fontColor($r("app.color.register_button_back_font"))
          .backgroundColor(Color.Transparent)
          .borderRadius(8)
          .border({
            width: 1,
            color: $r("app.color.register_button_back_border")
          })
          .margin({ top: 10 })
          .onClick(() => {
            this.uiContext.getRouter().pushUrl({
              url: Page.LOGIN_PAGE
            }).catch((e: Error) => {
              console.error(e.message);
            });
          });

        // ç³»ç»Ÿé”™è¯¯æç¤º
        if (this.errorMessage) {
          Row({ space: 8 }) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(Color.Red)
              .lineHeight(20)
          }
          .width('100%')
          .padding({ left: 8, right: 8, top: 8, bottom: 8 })
          .backgroundColor($r("app.color.register_row_error_background"))
          .borderRadius(8)
        }

        // ç‰ˆæœ¬ä¿¡æ¯
        Text($r("app.string.app_version"))
          .fontSize(12)
          .fontColor($r("app.color.register_test_version_font"))
          .margin({ top: 40 })
      }
      .width('85%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r("app.color.register_colum_main_background"))
    .justifyContent(FlexAlign.Start)
    .alignItems(HorizontalAlign.Center)
  }

  //å†…éƒ¨å®ç°

  // ç›´æ¥è·³è½¬ç‰ˆæœ¬
  private handleRegister() {
    console.log('å¼€å§‹æ³¨å†Œå¤„ç†');
    // éªŒè¯è¡¨å•
    if (!this.validateAll()) {
      console.log('è¡¨å•éªŒè¯å¤±è´¥');
      return;
    }
    // è®¾ç½®åŠ è½½çŠ¶æ€
    this.isLoading = true;
    this.errorMessage = '';
    console.log('è¡¨å•éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡ç›´æ¥è·³è½¬');

    // // è¿™é‡Œå‡è®¾æ³¨å†Œæ€»æ˜¯æˆåŠŸï¼Œç›´æ¥è·³è½¬åˆ°è”ç³»äººé¡µé¢
    // console.log('è·³è½¬åˆ°:', Page.CONTACT_LIST_PAGE);

    this.registerService.register(this.userName,this.passWord,this.email)
      .then((result:RegisterResult)=>{
        this.isLoading = false;

        if (result.success && result.user) {
          console.log('æ³¨å†ŒæˆåŠŸï¼Œç”¨æˆ·å¯¹è±¡:', result.user);

          // æ³¨å†ŒæˆåŠŸï¼Œä¿å­˜ç”¨æˆ·æ•°æ®
          // æ³¨æ„ï¼šUserManager.saveUserDataç°åœ¨éœ€è¦RegisterSuccessPayloadï¼Œä½†æˆ‘ä»¬å¯ä»¥ä¼ é€’Userå¯¹è±¡è½¬æ¢
          const userPayload : RegisterSuccessPayload= {
            userId: result.user.userId,
            username: result.user.username,
            email: result.user.email,
            avatar: result.user.avatar,
            token: result.user.token || ''
          };
          const savedUser = UserManager.saveUserData(userPayload, true);


          // æ˜¾ç¤ºæˆåŠŸæç¤º
          promptAction.showToast({
            message: loadStringResource(this.uiAbilityContext, $r("app.string.text_register_RegisterSuccess")),
            duration: 1500
          });
          router.pushUrl({
            url: Page.CONTACT_LIST_PAGE
          }).catch((err:Error) => {
            console.error('è·³è½¬å¤±è´¥:',err);
          })
        } else {
          // æ³¨å†Œå¤±è´¥
          console.log('æ³¨å†Œå¤±è´¥:', result.error);
          this.errorMessage = result.error || 'æ³¨å†Œå¤±è´¥';
        }
      })
      .catch((err: Error) => {
          console.error('è·³è½¬å¤±è´¥:', err);
          this.isLoading = false;
          this.errorMessage = loadStringResource(this.uiAbilityContext, $r("app.string.text_register_RegisterFailed")) + `: ${err.message}`;
    });
  }

  // æ›´æ–°å…¨å±€é”™è¯¯ä¿¡æ¯
  private updateErrorMessage(): void {
    this.errorMessage = '';
  }

  // éªŒè¯æ‰€æœ‰å­—æ®µ
  private validateAll(): boolean {
    console.log('éªŒè¯æ‰€æœ‰å­—æ®µ');

    this.userNameError = this.validateUserName(this.userName);
    this.emailError = this.validateEmail(this.email);
    this.passwordError = this.validatePassword(this.passWord);
    this.confirmPasswordError = this.validateConfirmPassword(this.passWord, this.passWord_check);

    const hasError = !!(this.userNameError || this.emailError || this.passwordError || this.confirmPasswordError);

    if (hasError) {
      console.log('éªŒè¯å¤±è´¥ï¼Œå­˜åœ¨é”™è¯¯');
    } else {
      console.log('æ‰€æœ‰å­—æ®µéªŒè¯é€šè¿‡');
    }

    return !hasError;
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ³¨å†Œ
  private canRegister(): boolean {
    // åªæœ‰æ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œä¸”æ²¡æœ‰æ­£åœ¨åŠ è½½æ—¶æ‰èƒ½æ³¨å†Œ
    const canRegister = this.userName.trim().length > 0 &&
      this.email.trim().length > 0 &&
      this.passWord.length > 0 &&
      this.passWord_check.length > 0 &&
      !this.isLoading;

    console.log(`canRegisteræ£€æŸ¥: ${canRegister}`);
    return canRegister;
  }

  // å„ä¸ªå­—æ®µçš„éªŒè¯å‡½æ•°
  private validateUserName(username: string): string {
    if (!username.trim()) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_UsernameRequireNotNull"));
    }
    const usernameRegex = /^[a-zA-Z0-9_]{5,20}$/;
    if (!usernameRegex.test(username)) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_UsernameInputError"));
    }
    return '';
  }


  //å®æ—¶è¡¨å•å…ƒç´ æ£€éªŒ
  private validateEmail(email: string): string {
    if (!email.trim()) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_EmailRequireNotNull"));
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_EmailInputError"));
    }
    return '';
  }

  private validatePassword(password: string): string {
    if (!password) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_PasswordRequireNotNull"));
    }
    if (password.length < 8) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_PasswordInputError"));
    }
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/;
    if (!passwordRegex.test(password)) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_PasswordRequireLettersAndNumbers"));
    }
    return '';
  }

  private validateConfirmPassword(password: string, confirmPassword: string): string {
    if (!confirmPassword) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_PasswordRequireConfirm"));
    }
    if (password !== confirmPassword) {
      return loadStringResource(this.uiAbilityContext, $r("app.string.error_register_PasswordConfirmError"));
    }
    return '';
  }
}