# 聊天消息收发
## 业务逻辑
### 客户端
客户端登录成功并加载联系人列表完成后，对于每个联系人，都向服务端发送一条 LOAD_MESSAGES 消息，将服务端返回的聊天消息列表储存在本地。

用户可以在聊天界面中手动请求刷新，将发送一条 LOAD_MESSAGES 消息，从服务端拉取当前联系人的聊天消息。

客户端请求发送聊天消息时，向服务端发送一条 SEND_MESSAGE 消息，等待服务器回应。

客户端收到服务端发来的 MESSAGE_RECEIVED_SELF 消息，则消息发送成功，将发送的聊天消息显示在聊天界面上；

客户端收到服务器发来的 MESSAGE_SEND_FAILED 消息，则聊天消息发送失败，显示错误信息。

客户端收到服务端发来的 MESSAGE_RECEIVED_OTHER 消息，说明有其他用户发来了新的聊天消息。此时根据 MESSAGE_RECEIVED_OTHER 消息内容，更新相应联系人的聊天消息列表。

客户端点击联系人列表中有新消息的联系人时，向服务端发送一条 MARK_READ 消息。

### 服务端
收到 LOAD_MESSAGES 消息时，从 messages 数据表中搜索出相应收发者的聊天消息，按消息 id 从小到大排列成列表，用 MESSAGES_LOADED 消息发送给客户端。

收到 SEND_MESSAGE 消息时，解析出 CloudChatMessage 对象，尝试更新 messages 数据表。

若更新 messages 成功，则回复 MESSAGES_RECEIVED_SELF 消息给客户端，同时若消息接收者用户在线，则向其发送 MESSAGE_RECEIVED_OTHER 消息；若更新 messages 失败，则回复 MESSAGE_SEND_FAILED 消息给客户端。

收到 MARK_READ 消息时，根据消息内容更新 messages 数据表，将指定收发者的聊天消息全部标记为已读。此操作无论成功失败都不回复客户端。

## 消息内容
每个消息的 id 由数据库生成，tempId 由客户端生成，服务端无需理会，仅作为客户端用于判断收发成功的临时标准

### 客户端 -> 服务端
#### LOAD_MESSAGES
```
userId: int       // 请求者id
targetId: int     // 请求联系人的id
```
#### SEND_MESSAGE
```
tempId: string    // 消息临时id
senderId: int     // 发送者id
receiverId: int   // 接收者id
content: string   // 消息内容
```
#### MARK_READ
```
userId: int       // 登录用户id
targetId: int     // 目标用户id
```
### 服务端 -> 客户端
#### MESSAGES_LOADED
```
messages: [CloudChatMessage]
 ```
#### MESSAGES_RECEIVED_SELF
```
tempId: string    // 客户端发来的消息临时id
id: int           // 数据库生成的id
```
#### MESSAGE_SEND_FAILED
```
tempId: string    // 客户端发来的消息临时id
error: string
```
#### MESSAGE_RECEIVED_OTHER
```
id: int           // 消息id
senderId: int     // 发送者id
receiverId: int   // 接收者id
content: string   // 聊天内容
timestamp: string // 时间戳
status: string = sent   // 状态
type: string = text     // 消息类型
```
