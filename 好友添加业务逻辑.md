# 好友添加
## 业务逻辑
### 客户端
#### 好友请求系统（维护好友请求列表）

客户端每次上线并初始化加载时，会向服务端发送一个发送 LOAD_FRIEND_REQUEST 消息请求获取当前用户的好友请求列表，然后等待服务端回复。

客户端点击“添加联系人”按钮后，向服务端发送一个 ADD_FRIEND_REQUEST 消息，然后等待服务端回复。

若未收到服务端回复，则判断为掉线，好友请求发送失败；若服务端的回复为 FRIEND_REQUEST_ADDED_FAILED，则好友请求发送失败；若服务端的回复为 FRIEND_REQUEST_ADDED，则好友请求发送成功。

好友请求发送成功后，相应好友请求会加入客户端的好友请求列表，好友请求列表中，对于发出的请求，会显示每一条请求的状态（待通过、已通过、已拒绝）。

客户端在线时，如果有其他用户请求添加自己为好友，会收到服务端发来的 ADD_FRIEND_REQUEST 消息，并将附带的好友请求信息加入好友请求列表。好友请求列表中，对于收到的请求，会提供两个选项——通过/拒绝。

客户端拒绝好友请求时，发送一条 REFUSE_FRIEND_REQUEST 消息给服务端。

客户端通过好友请求时，发送一条 ACCEPT_FRIEND_REQUEST 消息给服务端。

客户端收到服务端发来的 FRIEND_REQUEST_REFUSED / FRIEND_REQUEST_ACCEPTED 消息则更新好友请求列表。

客户端收到服务端发来的 FRIEND_REQUEST_REFUSED_FAILED / FRIEND_REQUEST_ACCEPTED_FAILED 消息则显示错误信息。

#### 联系人系统（维护联系人列表）

当客户端收到服务端发来的 CONTACT_ADDED 消息后，根据消息内容更新联系人列表。

### 服务端
#### 好友请求系统（维护好友请求列表）

服务端收到 LOAD_FRIEND_REQUEST 消息后，从 friend_requests 数据表中查询请求者用户的好友请求列表，查找成功则回复 FRIEND_REQUEST_LOADED 消息给客户端

服务端收到 ADD_FRIEND_REQUEST 消息后，尝试添加新的好友请求到 friend_requests 数据表，若添加成功，回复 FRIEND_REQUEST_ADDED 消息给客户端，好友请求目标用户如果在线，则向其客户端转发 ADD_FRIEND_REQUEST 消息；若添加失败，回复 FRIEND_REQUEST_ADDED_FAILED 消息给客户端。

服务端收到 REFUSE_FRIEND_REQUEST 消息后，尝试更新 friend_requests 数据表，若更新成功，回复 FRIEND_REQEUST_REFUSED 消息给客户端，如果发出好友请求的用户在线，则向其客户端转发 REFUSE_FRIEND_REQEUST 消息；若更新失败，回复 FRIEND_REQUEST_REFUSED_FAILED 消息给客户端。

服务端收到 ACCEPT_FRIEND_REQUEST 消息后，尝试更新 friend_requests 数据表，若更新成功，回复 FRIEND_REQUEST_ACCEPTED 消息给客户端，如果发出好友请求的用户在线，则向其客户端转发 ACCEPT_FRIEND_REQUEST 消息；若更新失败，回复 FRIEND_REQUEST_ACCEPTED_FAILED 消息给客户端。

#### 联系人系统（维护联系人列表）

服务端收到 ACCEPT_FRIEND_REQUEST 消息后，尝试更新 friends 数据表，若更新成功，发送 CONTACT_ADDED 消息给相应好友请求涉及的两个用户（如果在线）。

## 功能依赖

客户端下线和退出登录功能。

## 消息内容
每个请求消息的 id 由数据库生成，请求消息中的用户有两种类型：目标用户/请求用户。好友请求是由请求用户发给目标用户的
### 客户端 -> 服务端
#### LOAD_FRIEND_REQUEST
```
userId: int         // 请求的客户端用户id
```
#### ADD_FRIEND_REQUEST
```
id:                int
requesterId:       int
targetId:          int
requesterUsername: string
targetUsername:    string
requesterAvatar:   string
targetAvatar:      string
status:            string
```
#### REFUSE_FRIEND_REQUEST
```
id: int             // 被拒绝的请求消息id
```
#### ACCEPT_FRIEND_REQUEST
```
id: int             // 被同意的请求消息id
```
### 服务端 -> 客户端
#### CONTACT_ADDED
```
userId: int         // 将被添加的用户id
username: string    // 将被添加的用户名
online: bool        // 将被添加的用户在线状态
avater: string      // 将被添加的用户头像URL
```
#### FRIEND_REQUEST_LOADED
```
requests: List<
    id: int             // 请求消息id
    requesterId: int    // 请求发出者 id
    targetId: int       // 请求目标 id
    requesterUsername: string // 请求发出者用户名
	targetUsername: string    // 请求目标用户用户名
    requesterAvatar: string   // 请求发出者头像 URL
	targetAvatar: string      // 请求目标头像 URL
    status: string            // 当前消息状态（待通过、已通过、已拒绝）
>
```
#### FRIEND_REQUEST_ADDED
```
id:                int
requesterId:       int
targetId:          int
requesterUsername: string
targetUsername:    string
requesterAvatar:   string
targetAvatar:      string
status:            string
```
#### FRIEND_REQUEST_ADDED_FAILED
```
error: string       // 错误报告
```
#### ADD_FRIEND_REQUEST
```
id: int
requesterId: int
targetId:    int
requesterUsername: string
targetUsername:    string
requesterAvatar:   string
targetAvatar:      string
status:            string
```
#### FRIEND_REQUEST_REFUSED
```
id: int // 被拒绝的请求 id
```
#### FRIEND_REQUEST_ACCEPTED
```
id: int // 被通过的请求 id
```
#### FRIEND_REQUEST_REFUSED_FAILED
```
id: int             // 理应被拒绝的请求消息id
error: string       // 错误消息
```
#### FRIEND_REQUEST_ACCEPTED_FAILED
```
id: int             // 理应被同意的请求消息id
error: string       // 错误消息
```
#### REFUSE_FRIEND_REQUEST
```
id: int             // 被拒绝的请求消息id
```
#### ACCEPT_FRIEND_REQUEST
```
id: int             // 被同意的请求消息id
```
